---
title: "Traditional agroforestry systems in Timor-Leste can store large amounts of carbon in both soil and biomass"
author: "Marguerite Cogné, Régis Peltier, Vincent Freycon, Alexis Toumazeau, Camille Piponiot"
date: "2024-03-19"
output: 
  bookdown::word_document2:
  fig_caption: yes
bibliography: references.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message=FALSE, results = "hide", tinytex.clean = FALSE)
packages_needed = c("ggplot2", "readxl", "data.table", "knitr", "BIOMASS", "terra", "utils", "car")

packages_to_install = packages_needed[!( packages_needed %in% rownames(installed.packages()))]

if (length(packages_to_install) > 0)
  install.packages(packages_to_install)

lapply(packages_needed, require, character.only = TRUE)
```

**Journal**: Agroforestry Systems

**Max words**: The total length of Original Articles, including figures, tables and references, should not exceed **10,000 words**. The number of figures and tables should not exceed 10 in total.

**Word count**: xxx; **Figure and table count**: 5

# Abstract

Agroforestry has the potential to make agriculture more resilient while improving carbon sequestration by incorporating trees and other woody perennials into agricultural fields and diversifying agricultural landscapes. Traditional agricultural systems in tropical areas often include trees, but their carbon sequestration potential is not always well described, hindering their potential inclusion in climate change mitigation strategies. In this study, we quantified carbon storage in both vegetation biomass and soil in five traditional agroforestry systems (AFS) in Timor-Leste:  cropping systems with fallow, silvopastoral systems, young agroforests, home gardens and forest gardens. Our results show that these traditional AFS store large amounts of carbon: the AFS with the highest carbon stocks (forest gardens) stored an average of 255 MgC/ha, similar to an old-growth tropical forest. Biomass carbon was strongly dependent on the type of AFS (which differed in tree cover), while soil carbon was less variable between AFS but more dependent on site. We found no relationship between the amount of carbon stored in biomass and soil. Our results highlight the high diversity of traditional agroforestry systems in Timor-Leste and their high capacity to store carbon.

# Introduction

Agricultural expansion has been the main driver of tropical deforestation over the past half century [@Pendrill2022;@Gibbs2010;@Rudel2009], resulting in large greenhouse gas emissions [approximately 2.6 gigatonnes CO2e/yr over 2010-2014; @Pendrill2019]. The demand for tropical agricultural land is expected to continue to increase as the population grows [@UN2022]. In addition, tropical areas are expected to be disproportionately affected by climate change, putting their agriculture and food systems at risk [@Lawrence2015]. There is therefore an urgent need to promote tropical agricultural landscapes that are both more resilient to climate change, while maintaining high productivity and ecological value [@Harvey2014]. In particular, increasing the carbon stored in the soil and vegetation of agricultural landscapes could be an effective way to mitigate climate change while increasing the resilience of the food production system [@Lal2004;@Minasny2017].

Agroforestry has attracted attention in recent decades as a set of effective agricultural practices that could contribute to climate change mitigation and adaptation [@Albrecht2003;@Verchot2007;@Lasco2014;@Cardinael2021]. Agroforestry is a collective name for land use systems and technologies where woody perennials (trees, shrubs, bamboos, creepers, etc.) are deliberately used on the same land management units as agricultural crops and/or animals, in some form of spatial arrangement or temporal sequence [@Lundgren1982]. Agroforestry allows for diversification of agricultural production, making agricultural systems more resilient [@Duffy2021;@Terasaki2023]. 

Agroforestry systems (AFS) have the potential to store large amounts of carbon in the vegetation and soil, and this carbon storage capacity depends on the characteristics of AFS considered [@Albrecht2003;@Feliciano2018]. As trees store large amounts of carbon, the carbon stored in the vegetation of AFS is largely dependent on the number and size of trees in the system [@Ma2020]. However, the effect of AFS on soil organic carbon (SOC) has been relatively little studied [@Beillouin2021], is more variable and depends on a number of factors. Although AFS appear to increase SOC stocks overall, some AFS such as woodlots (i.e. planting trees with intercropping during the establishment phase) may decrease SOC compared to non-AFS, while AFS such as silvopastoral systems have been shown to strongly increase SOC stocks [@Feliciano2018]. Other factors such as climate and previous land use type have also been shown to strongly influence SOC in AFS, which may explain the variability of observations reported in the literature [@Feliciano2018;@Ma2020;@Martin2020]. Furthermore, the relationship between the amount of carbon stored in aboveground vegetation and soil in AFS could only be demonstrated for the topsoil layer [< 10 cm; @Ma2020]. 

Although AFS can make agriculture more resilient while improving its carbon footprint, poor adaptation to the local context can explain many failures to introduce new agroforestry techniques [@Coe2014]. Conversely, some traditional agroforestry techniques have evolved in a particular context (biophysical, social and economic) and are therefore adapted to it [@Gouyon1993;@Aumeeruddy1994;@Peltier1996]. Moreover, traditional small-scale AFS typically retain high levels of biodiversity, making them key elements for biodiversity conservation in the tropics [@Perfecto2008;@Torquebiau1992]. A better understanding of traditional agroforestry practices and their ecological characteristics could provide better support for the local development of agroforestry.

In Timor-Leste, a large proportion of the population depends on agriculture for their livelihoods, but food security is threatened by population growth, increasing pressure on natural resources, and an increasingly variable climate with an unreliable rainfall regime [@WB2009;@Molyneux2012]. In this context, productive, resilient and sustainable agriculture is critical for the country, and agroforestry has been presented as a potential solution to many of the challenges facing Timorese agriculture [@Paudel2022;@Cogne2024]. Although trees already form a large part of traditional agricultural systems in Timor-Leste [@Paudel2022;@Cogne2024], they have received little attention and, to our knowledge, no study has quantified carbon storage in traditional Timorese AFS. Better quantification of these carbon stocks would improve the understanding of the ecological importance of these AFS at both local and global scales, and help to integrate them into national and international climate change mitigation initiatives.

In this study, we aim to better understand traditional agroforestry systems in Timor-Leste, and in particular their carbon storage both in their biomass and in the soil. We hypothesize that different types of traditional agroforestry systems will exhibit measurable differences in aboveground carbon (AGC; H1a) and SOC (H1b) stocks. We also assume, following @Ma2020, that there is a positive relationship between AGC and SOC stocks in the topsoil layer (0-10 cm; H2a), but no relationship with SOC below 10 cm (H2b).

# Materials and methods

```{r download-data}
## download data from dataverse - once published
dataverse_url <- "https://dataverse.cirad.fr/privateurl.xhtml?token=f8eabb2a-3635-499b-aee5-80fd2b7495a0"
dataverse_doi <- "10.18167/DVN1/QCXWIY"

# for now : download manually from temporary link
if (!dir.exists("data")) create.dir("data")
# utils::unzip("data/dataverse_files.zip")
``` 

## Study area

```{r get-site-info}
## Load plot location data 
data_coord <- read_xlsx("data/DATA_BIOMASS_TL_LARGE.xlsx", sheet = "GPS")
setDT(data_coord)

# get plot number
data_coord[, N_PLOT := as.numeric(data.table::tstrsplit(N_Q_ID, "_")[[1]])]

# get coordinates
data_coord <- data_coord[, .(long = mean(as.numeric(LONG)), lat = mean(as.numeric(LAT))), .(N_PLOT)]

## Load plot general information
data_plot <- readxl::read_excel("data/DATA_BIOMASS_TL_SHORT.xlsx", "PLOT_GENERAL_INFO")

# merge plot coordinates with general information (site, AFS)
data_plot <- merge(data_coord, data_plot[, c("N_PLOT", "ID_VILLAGE", "ID_AF", "AREA_TOTAL_PARCEL")])

# simplify site names
data_plot[, site := substr(ID_VILLAGE, 1, 1)]
data_plot[site == "S", site := "Osso Luga"]
data_plot[site == "G", site := "Gariuai"]
```


```{r get-env-data}
# precipitation from CHELSA
if (!file.exists("data/CHELSA_bio12_1981-2010_V.2.1.tif")) {
  url <- "https://os.zhdk.cloud.switch.ch/envicloud/chelsa/chelsa_V2/GLOBAL/climatologies/1981-2010/bio/CHELSA_bio12_1981-2010_V.2.1.tif"
  destfile <- "data/CHELSA_bio12_1981-2010_V.2.1.tif"
  utils::download.file(url, destfile, method = "curl")
  
  ## crop to reduce memory usage
  box = c(124.5, 127.5, -9.2, -8.3) # Timor Leste
  rst <- terra::rast(destfile)
  rst <- terra::crop(rst, terra::ext(box))
  terra::writeRaster(rst, filename = destfile, overwrite = TRUE) 
} 

# 30m resolution SRTM
if (!file.exists("data/CHELSA_bio12_1981-2010_V.2.1.tif")) {
  url <- "https://srtm.csi.cgiar.org/wp-content/uploads/files/srtm_5x5/TIFF/srtm_62_14.zip"
  destfile <- "data/srtm_62_14.zip"
  utils::download.file(url, destfile, method = "curl")
  utils::unzip(destfile, exdir = "data", overwrite = TRUE)
} 

# download cwd from Chave et al 2014
if (!file.exists("data/CWD.tif")) {
  url <- "http://chave.ups-tlse.fr/pantropical_allometry/CWD.tif.zip"
  destfile <- "data/CWD.tif.zip"
  utils::download.file(url, destfile, method = "curl")
  utils::unzip(destfile, exdir = "data", overwrite = TRUE)
}
```


```{r extract-env-data}
# extract elevation and rainfall for the 2 sites
site_env = data_plot[, as.list(expand.grid(seq(min(long), max(long), 0.001), 
                                              seq(min(lat), max(lat), 0.001))),
                        .(site)]

colnames(site_env) = c("site", "long", "lat")

# TODO add code to download prec and elev
site_env[, prec := terra::extract(
  terra::rast("data/CHELSA_bio12_1981-2010_V.2.1.tif"), 
  cbind(long, lat)
)]

site_env[, elev := terra::extract(
  terra::rast("data/srtm_62_14.tif"), 
  cbind(long, lat)
)]

site_summary = site_env[, .(
  coord = paste(round(mean(long),2), round(mean(lat),2), sep = ", "), 
  prec = round(mean(prec)), 
  elev = paste(round(quantile(elev, c(0.025, 0.975))), collapse = " - ")),
  .(site)]
```

The research was carried out in the center of the Baucau district, on the north-eastern coast of Timor-Leste. Two communities, or suco (group of villages), were selected to represent two contrasting topo-geographical, climatic and historical cases: (i) Gariuai suco (long-lat coordinates: `r site_summary[site=="Gariuai", coord]`) is located on a plateau of Baucau limestone, with an annual rainfall of `r site_summary[site=="Gariuai", prec]` mm and an altitude ranging 300-750 m; and (ii) the village of Osso Luga in Samalari suco (long-lat coordinates: `r site_summary[site=="Osso Luga", coord]`) is located on the Matebian foothill based on Bobonaro Scaly Clay, with an annual rainfall of `r site_summary[site=="Osso Luga", prec]` mm and an altitude ranging `r site_summary[site=="Osso Luga", elev]` m (Fig. \@ref(fig:map-sites)). The average soil properties differed between sites (Table \@ref(tab:stab-site-soil)), with Gariuai having Clay Loam soil texture compared to Osso Luga having clay soil texture. The two sites also have had different histories. Gariuai has been inhabited for at least 50 years, while Osso Luga was abandoned during the Indonesian occupation, and was only repopulated after 2000. During the period of abandonment, the various agroforestry systems in Osso Luga lay fallow.

## Typology of agroforestry systems

We used the typology described in @Cogne2024, developed in the same study area. This typology was based on the one proposed by @Nair1993;@Nair2022, and adapted to the local context with semi-structured interviews conducted in the same study area [@Cogne2024]. The five AFS identified were: crop system including a wooded fallow phase (CF), Sylvopastoral (SP), Young agroforest (YA), Home garden (HG) and Forest garden (FG). CF are plantations of a few non-perennial crops (such as maize, sweet potatoes, groundnuts and squash) which are left fallow after 1 to 3 years. SP land is a vast area (generally 200 to 500 ha) where cattle are grazed under a layer of trees. YA are agricultural plots where the farmer has been planting rows of trees, spaced at around 5x10m, for two to 10 years, usually with the help of projects. HG are plots of land close to houses, where crops and livestock (poultry, pigs, cattle, etc.) have been grown in the shade of numerous trees and palms for multiple uses (wood, fruit, fibre, etc.) for more than five years. FGs are generally former HGs (over 50 years old), which have been abandoned, for example as a result of the war, and are now used mainly for gathering with limited human influence.

The AFS are presented in more detail in the supplemental information (Table \@ref(tab:afs-typology)) and in @Cogne2024. 

## Field inventories

We randomly selected 3 plots from each of the 5 traditional AFS identified in each of the two sites (30 plots in total; Fig. \@ref(fig:map-sites)). Sampling plots were defined as the entire agricultural plot (area between 0.06-1.25 ha) for all AFS except SP plots, which were generally much larger than 1 ha. In SP plots, a 1 ha sampling plot was delineated within the agricultural plot. Tree and soil measurements (described below) were carried out between June and August 2021. 

### Tree measurements

Within each sampling plot, all trees with a circumference at breast height (CBH) greater than or equal to 100 cm were identified taxonomically and their CBH and height were measured. Five subplots of 10x10 m (0.01 ha) were established at each corner and in the center of the sampling plot (Fig. \@ref(fig:design)): within these subplots, all trees with a CBH between 30 and 100 cm were taxonomically identified and their CBH and height were measured. Height measurements were done with a dendrometer. 

Taxonomic identification was carried out using tetum vernacular names, which were then linked to scientific names using iNaturalist and Pl\@ntnet application, Geoffrey Hull’s monograph [@Hull2006], the data bases of “the useful tropical plants” (https://tropical.theferns.info/) as well as the native plants websites of the NT herbarium from the Australian government (https://nt.gov.au/environment/native-plants/native-plants-and-nt-herbarium). The correspondence between tetum names and scientific names is provided in the supplemental material (Table \@ref(tab:tetum-names)). 

### Soil measurements

In each of the 30 sampling plots, a composite of 3 samples were collected following a transect to cover the plot’s inner-variability (Fig. \@ref(fig:design)). Soils were sampled with an auger at 0-10 cm and 20-30 cm. Soils samples were then air-dried and sieved at 2 mm. They were the subject of standard physical and chemical analyses at Cirad laboratories in Montpellier, France. Among these analyses, total organic carbon was determined by dry combustion and measured with a thermal conductive detector.

In addition, at one location at the center of the plot, soils were sampled with a cylinder of 250 cm$^3$ at 2-7 cm, 12-17 cm and 22-27 cm. Each sample was dried at 105°C in a classic oven until reaching a stable dry mass, sieved to 2 mm, and then the fine fraction (< 2 mm) was weighted. 

## Biomass estimation

```{r agc-estimation}
### 1. Open data 

# Open large tree data (> 100 cm circumference)
data_large <- readxl::read_excel("data/DATA_BIOMASS_TL_SHORT.xlsx", "TREE INV >100CM")

# Open small tree data (30-100 cm circumference)
data_small <- readxl::read_excel("data/DATA_BIOMASS_TL_SHORT.xlsx", "TREE INV 30-100CM")

### 2. Combine tables

# create a "N_Q_ID" column in data_large, with corresponding quadrat number =
# "TOT" (entire plot)
data_large$N_Q_ID <- paste(data_large$N_PLOT, "TOT", sep = "_")

# common columns to be kept
col_keep <- c("N_PLOT", "N_Q_ID", "SCIENTIFIC_NAME", "DIAM_130_CM", "HEIGHT")

# stack tree tables
data_tot <- rbind(data_large[, col_keep], data_small[, col_keep])

# merge with plot information
data_tot <- merge(data_tot, data_plot, by = "N_PLOT")

# convert data_tot into data.table 
data.table::setDT(data_tot)

### 3. Clean tables 

# remove NA or <30 cm circumference values or < 100 cm outside subplots
data_tot <- subset(data_tot, 
                   !is.na(DIAM_130_CM) & 
                     DIAM_130_CM >= 30/pi &
                     (DIAM_130_CM >= 100/pi | grepl("Q", N_Q_ID)))

# split scientific names into genus and species
names <- data.table::tstrsplit(data_tot$SCIENTIFIC_NAME, " ")

# get genera
data_tot$GENUS <- names[[1]]

# get species
data_tot$SPECIES <- names[[2]]

# Timoneus should be Timonius
data_tot$GENUS[!is.na(data_tot$GENUS) & data_tot$GENUS == "Timoneus"] <- "Timonius"

# remove one tree with DBH = 0
data_tot <- subset(data_tot, DIAM_130_CM > 0)

### 4. Get values for Chave et al., 2014 equation

# get wood density
data_wd <- BIOMASS::getWoodDensity(genus = data_tot$GENUS, species = data_tot$SPECIES) 

# 15% coefficient of variation on height
cvH <- 0.15

### estimate AGC
data_sim_agc <- data.table(
  data_tot,
  BIOMASS::AGBmonteCarlo(
    D = data_tot$DIAM_130_CM, 
    WD = data_wd$meanWD, 
    errWD = data_wd$sdWD, 
    H = data_tot$HEIGHT, 
    errH = data_tot$HEIGHT*cvH, 
    Dpropag = "chave2004", 
    n = 1000,
    Carbon = TRUE
  )$AGC_simu
) |> 
  melt(
    measure.vars = paste0("V", 1:1000),
    variable.name = "iter",
    value.name =  "AGC"
  )

### 5. Apply a different allometry for palms
palm_genera <- c("Cocos", "Areca", "Arenga", "Corypha", "Borassus")

## height in cm, with a conversion factor between 0.8 and 1
data_sim_agc[GENUS %in% palm_genera, 
             HEIGHT := rnorm(1, HEIGHT, HEIGHT*cvH)*
               runif(1, .8, 1)* 100]

## add WD data
data_wd_palms = unique(data_wd[data_wd$genus %in% palm_genera, c("genus", "meanWD", "sdWD")])
data_sim_agc = merge(data_sim_agc, data_wd_palms, all.x = TRUE, by.x = "GENUS", by.y = "genus")
data_sim_agc[GENUS %in% palm_genera, WD := rnorm(1, meanWD,sdWD)]

data_sim_agc[GENUS %in% palm_genera, 
             AGC := WD * HEIGHT * (DIAM_130_CM/2)^2 * pi * 
               0.89 * # volumetric shrinkage
               1e-6  # convert from g to tons
]
```

We estimated tree-level AGC stocks from the measured tree CBH and height using the pantropical allometric equation from @Chave2014 and the R package BIOMASS [@Rejou-Mechain2017]. Each tree was assigned a mean and standard deviation of wood density at the species or genus level when at least one value was available from the Global Wood Density Database [@Zanne2009]. Other taxa were assigned a plot-level average wood density. The biomass of the palms was estimated by multiplying their estimated volume by their estimated wood density. The volume of the palm trunks was estimated as the volume of a cylinder, using the height and diameter measured in situ, with a volumetric shrinkage of 11% [@WD2023]. The height of the palms was measured above the leaves and was therefore multiplied by a conversion factor of 0.9 to obtain the trunk height.

Tree-level belowground carbon (BGC) stocks were estimated using the root-to-shoot ratio equation from @Ledo2018, which is based on tree DBH and climatic water deficit from @Chave2014. This ratio was then multiplied by the estimated aboveground carbon stock to obtain tree-by-tree belowground carbon stock. 

```{r bgc-estimation}
# root-to-shoot ratio allometry from Ledo et al., 2018
# use CWD values from Chave et al., 2014
data_plot[, cwd := terra::extract(terra::rast("data/CWD.tif"), cbind(long, lat))]
data_sim_agc <- merge(data_sim_agc, data_plot[, c("N_PLOT", "cwd")], by = "N_PLOT")

# add uncertainty on R:S ratio? 
data_sim_agc[, RS := exp(- 1.2312 - 0.0215 * DIAM_130_CM + 0.0002 * DIAM_130_CM^2 - 0.0007 * cwd)]
data_sim_agc[, BGC := RS * AGC]
```

Plot-level AGC and BGC stocks were then obtained by summing tree-level stocks and dividing by the plot area.

```{r aggregate-biomass-data}
# replace with area = 0.05 for quadrats (5 quadrats of 0.01 ha each)
data_sim_agc[, area := ifelse(grepl("Q", N_Q_ID), 0.01, AREA_TOTAL_PARCEL)]

# melt data frame
data_sim <- melt(data_sim_agc, id.vars = c("N_PLOT", "N_Q_ID", "ID_VILLAGE", "ID_AF", "iter", "area"), measure.vars = c("AGC", "BGC"))

# estimate biomass per quadrat and plot
data_sim <- data_sim[, .(value = sum(value/area)), .(N_PLOT, N_Q_ID, ID_VILLAGE, ID_AF, iter, variable)]

## bootstrap AGC and BGC values in small plots
data_sim = 
  merge(
    data_sim[!grepl("Q", N_Q_ID)], 
    data_sim[grepl("Q", N_Q_ID), .(
      valueSmall = ifelse(
        length(value) == 0,   ## some quadrats have zero trees: complete their values
        0, 
        mean(sample(c(value, rep(0, 5 - length(value))), replace = TRUE))
      )), .(N_PLOT, variable, iter)], 
    by = c("N_PLOT", "variable", "iter")
  )

data_sim[, value := value + valueSmall]
```

## Soil organic carbon estimation

Soil organic carbon stocks (in Mg.ha$^{-1}$) were then calculated using the method recommended by @Poeplau2017 (M4), which correctly takes into account the coarse fraction of the soil:

$$SOC_i = \frac{\sum_i Corg_i \cdot (mfine_i \cdot 10-6) \cdot (Splot \cdot \Delta d)}{Vcyl}$$  

Where $Corg_i$ is the organic carbon content at depth $i$ (either 0-10, 10-20 or 20-30 cm); $mfine_i$ is the mass of the fine fraction of the soil in the sampling cylinder at depth $i$ (in g), converted into Mg with a factor of 10$^{-6}$; Splot is the surface of a 1-ha plot (10$^8$ cm$^2$); $\Delta d$ is the difference in sample depths (= 10 cm) and $Vcyl$ is the volume of the sampling cylinder (250 cm$^3$). At depth $i$ = 10-20 cm, where the carbon content was not measured (see "Soil measurements" section), we used the average of the carbon content values at 0-10 and 20-30 cm.  


```{r open-soil-data}
# open soil lab data
data_soil_lab <- readxl::read_excel("data/RESUME_DATA_SOIL_SHORT_TL.xls", sheet = "RESUME-LAB ")

# open soil field measurements
data_soil_field <- readxl::read_excel("data/RAW_DATA_SOIL_LARGE_TL.xls", sheet = "SAMPLING_MEASURE")

# change format of depth to correspond to other soil table
data_soil_field$SAMPLE_DEPTH <- factor(data_soil_field$DEPTH_SAMPLE_C, levels = c("2_7", "12_17", "22_27"))
levels(data_soil_field$SAMPLE_DEPTH) <- c("0-10", "10-20", "20-30")

data_soil <- merge(data_soil_lab, data_soil_field, by = c("N_PLOT", "SAMPLE_DEPTH"), all=TRUE)
data.table::setDT(data_soil)
```

```{r add-missing-values}
## add intermediate soil carbon in 10-20 cm depth
data_soil[, Corg := `Corg\n`]
data_soil[, muCorg := mean(Corg, na.rm = TRUE), .(N_PLOT)]
data_soil[is.na(Corg), Corg := muCorg]
```

```{r soc-error-propagation}
data_soil[, c("h0", "h1") := lapply(data.table::tstrsplit(SAMPLE_DEPTH, "-"), as.numeric)]

## error propagation using a Monte Carlo method -------------
data_sim_soil = data_soil[, .(mfine = rnorm(1000, Sample_DRY, Sample_DRY*0.1), # 10% error on fine soil mass
                              Corg = rnorm(1000, Corg, Corg*0.12), # 12% error on C content measurement
                              iter = paste0("V", 1:1000)), 
                          .(N_PLOT, SAMPLE_DEPTH, h1, h0)]

data_sim_soil[, Cstock :=             ## in Mg/ha
                (h1 - h0) * 1e8 *     ## equivalent volume of a 1 ha soil sample, in cm3/ha
                Corg/100 *            ## carbon organic content in fine soil (unitless)
                (mfine * 1e-6) * ## mass of the fine fraction of the soil (Mg)
                (1/250)        ## 1/volume of the cylinder, in cm-3
]

# sum over depths + at 0-10 cm depth
data_sim_soil = data_sim_soil[, .(
  SOC = sum(Cstock), 
  SOC10 = Cstock[SAMPLE_DEPTH == "0-10"]),
  .(N_PLOT, iter)
]

## melt data 
data_sim_soil = melt(data_sim_soil, id.vars = c("N_PLOT", "iter"))
```

```{r merge-all}
## merge with biomass data
data_sim = rbind(data_sim[, colnames(data_sim_soil), with = FALSE], data_sim_soil) |> 
  merge(data_plot[, c("N_PLOT", "site", "ID_AF")], by = "N_PLOT")

# add total carbon stocks
data_sim = rbind(data_sim, data_sim[, .(value = sum(value[variable != "SOC10"]), variable = "TOT"), .(N_PLOT, site, ID_AF, iter)])
```

## Statistical analysis

### Statistical tests

The estimated AGC and SOC stocks were log-transformed for all statistical tests, because we expect them to be log-normally distributed as they only take positive values. After testing for normality (Shapiro-Wilks test) and homoscedasticity (Levene’s test), we performed a two-way ANOVA on the log-transformed estimates of AGC and SOC stocks, grouped by AFS and site. To test the relationship between log-transformed SOC and AGC stocks, we fitted two linear mixed models. We predicted SOC stocks at two different depths (either 0-10 or 0-30 cm) as a function of AGC stocks (fixed effect) and site (Samalari or Osso-Luga; random effect).

### Uncertainty propagation

The uncertainty on plot-level AGC was calculated with the AGBmonteCarlo() function from the BIOMASS package, using a (rather conservative) coefficient of variation of 15% on height measurements (Hunter et al 2013); large and small errors on 5 and 95% of trees respectively (Chave et al 2004; Réjou-Méchain et al., 2017).
To propagate uncertainty on SOC estimates, we used a coefficient of variation of 12% for organic carbon (Cirad laboratory in Montpellier, France), 10% for the mass of the fine fraction (Page-Dumroese et al. 1999). 

We then propagated these uncertainties using a Monte Carlo method (1000 iterations). For single plot estimates of carbon stocks, medians and 95% confidence intervals were estimated as quantiles of the results of the 1000 iterations. For multiplot estimates of carbon stocks, values within each grouping factor were additionally bootstrapped before calculating quantiles (median and 95% confidence intervals). 

```{r boot-results}
# plot level statistics
dataC_plot = data_sim[, .(
  mean = mean(value),
  lwr = quantile(value, 0.025),
  med = quantile(value, 0.5),
  upr= quantile(value, 0.975)
), .(plot = N_PLOT, site, afs = ID_AF, variable)]

# AFS level statistics (with bootstrapping)
dataC_afs = data_sim[, .(
  mean = mean(value),
  meanBs = mean(sample(value, replace = TRUE))
), .(afs = ID_AF, variable, iter)][, .(
  mean = mean(mean),        
  lwr_mean = quantile(meanBs, 0.025),   
  upr_mean = quantile(meanBs, 0.975)
), .(afs, variable)]

# site level statistics (with bootstrapping)
dataC_site = data_sim[, .(
  mean = mean(value),
  meanBs = mean(sample(value, replace = TRUE))
), .(site, variable, iter)][, .(
  mean = mean(mean),        
  lwr_mean = quantile(meanBs, 0.025),   
  upr_mean = quantile(meanBs, 0.975)
), .(site, variable)]
```

```{r group-comparison}
# shapiro wilk test - normality
dataC_plot[variable %in% c("AGC", "SOC"), .(
  shap = shapiro.test(log(mean))$p.value
), .(afs, variable)]
# levene test of homoscedasticity
dataC_plot[variable %in% c("AGC", "SOC"), 
           leveneTest(log(mean) ~ afs*site)$`Pr(>F)`[1], .(variable)]

# 2-way anova 
anova_table = 
  dataC_plot[variable %in% c("AGC", "SOC"), 
           .(pvalue = round(anova(lm(log(mean) ~ site + afs))$`Pr(>F)`[1:2], 3)), 
                   .(variable)]
anova_table$factor = rep(c("site", "afs"), 2)
```

# Results

```{r summary, results = "show"}
# calculate median and 95% confidence interval at site level
dataC_afs[, value := paste0(
  signif(mean, 3), " (",
  signif(lwr_mean, 3), "-", 
  signif(upr_mean, 3), ")")] |> 
  subset(variable != "SOC10") |> 
  dcast(afs ~ variable, value.var = "value") |> 
  knitr::kable(col.names = c("Agroforestry system", 
                             "Aboveground carbon (MgC/ha)", 
                             "Belowground carbon (MgC/ha)", 
                             "Soil organic carbon (MgC/ha)", 
                             "Total carbon (MgC/ha)")) 
```


```{r anova, results = "show"}
knitr::kable(anova_table[, c("variable", "factor", "pvalue")])
```

```{r map-sites, fig.height = 6, fig.width = 7}

## site location: create box around plots
data_box = data_plot[, .(xc = mean(long), yc = mean(lat)), .(site)]
data_box[site == "Gariuai", `:=`(w = 0.1, xc = xc + 0.001)]
data_box[site == "Osso Luga", w := 0.05]
data_box[, `:=`(x1 = xc - w/2, x2 = xc + w/2, y1 = yc - w/2, y2 = yc + w/2)]

## create Timor map
bbox <- c(124.5, -9.2, 127.5,  -8.3)
timor_map <- map_data("world", region = "Timor-Leste")

g1 = ggplot(timor_map) + 
  annotate(geom = "text", label = "a", x = -Inf, y = Inf, 
           hjust = 0, vjust = 1, fontface = "bold", size = 6) + 
  geom_polygon(aes(x = long, y = lat, group = group), fill="lightgray", colour = "grey") +
  geom_tile(data = data_box, aes(x = xc, y = yc, width = w, height = w), fill = NA, color = 1, linewidth = 0.5) +
  ggrepel::geom_text_repel(data = data_box, aes(x = xc, y = yc, label = site)) + 
  labs(x = "", y = "") +
  theme(legend.position = "top", axis.title = element_blank(), 
        axis.ticks = element_blank(), axis.text = element_blank(), 
        panel.background = element_blank())+
  coord_sf(crs = 'WGS84')

# get elevation information
elev = as.data.frame(terra::rast("data/srtm_62_14.tif"), xy = TRUE)
elevS <- subset(elev, x > data_box[site == "Osso Luga"]$x1 & 
                  x < data_box[site == "Osso Luga"]$x2 & 
                  y > data_box[site == "Osso Luga"]$y1 & 
                  y < data_box[site == "Osso Luga"]$y2)
elevS$site = "Osso Luga"
elevG <- subset(elev, x > data_box[site == "Gariuai"]$x1 & 
                  x < data_box[site == "Gariuai"]$x2 & 
                  y > data_box[site == "Gariuai"]$y1 & 
                  y < data_box[site == "Gariuai"]$y2)
elevG$site = "Gariuai"

elevAll = rbind(elevS, elevG)

## Map of sites and plots with elevation
g2 = 
  ggplot(data = elevAll) +
  geom_raster(aes(x = x, y = y, fill=srtm_62_14)) +
  geom_point(data = data_plot, 
             aes(x = long, y = lat, color = ID_AF), size = 2) + 
  geom_point(data = data_plot, 
             aes(x = long, y = lat), shape = 1, size = 2) + 
  # coord_equal() +
  # viridis::scale_fill_viridis(option = "D",
  #                             limits = range(c(elevS$srtm_62_14, elevG$srtm_62_14))
  # ) +
  scale_fill_gradientn(colours = terrain.colors(10)) +
  scale_color_manual(values = RColorBrewer::brewer.pal(n = 6, name = 'Dark2')[-5]) +
  labs(x = NULL, y = NULL, color = NULL, fill="Elevation (m)") +
  annotate(geom = "text", label = "b", x = -Inf, y = Inf, 
           hjust = -0.5, vjust = 1, fontface = "bold", size = 6) + 
  annotate(geom = "text", label = "c", x = Inf, y = -Inf, 
           hjust = 12, vjust = -9.8, fontface = "bold", size = 6) + 
  guides(color = FALSE, fill=guide_colorbar(title.position = "top")) +
  theme(legend.position = c(0.8, 0.85), legend.direction="horizontal", 
        axis.title = element_blank(),
        # axis.ticks = element_blank(), axis.text = element_blank(), 
        plot.title = element_text(hjust = 0.5), 
        panel.background = element_blank()) +
  scale_x_continuous(expand = c(0, 0)) + scale_y_continuous(expand = c(0, 0))+
  ggspatial::annotation_scale() +
  coord_sf(crs = 'WGS84')

# get AFS legend
g3 = ggplot(data_plot) +
  geom_point(aes(x = long, y = lat, color = ID_AF)) + 
  labs(color = "AFS") +
  guides(color=guide_legend(ncol=2)) +
  scale_color_manual(values = RColorBrewer::brewer.pal(n = 6, name = 'Dark2')[-5]) +
  theme_classic()
l1 = ggpubr::get_legend(g3)

ggpubr::ggarrange(ggpubr::ggarrange(g1, l1), g2, ncol = 1, heights = c(1,2))

ggsave("figures/mapPlotsSRTM.png", height =4.5, width = 6)
```

```{r fig-2-barplot, fig.height = 5, fig.width = 6}
## melt data.table
dataC_all <- melt(dataC, id.vars = c("N_PLOT", "ID_VILLAGE", "ID_AF", "site"), 
                  measure.vars = c("meanAGC", "meanBGC", "meanSOC"))

dataC_all <- dataC_all[, .(value = mean(value, na.rm = TRUE)), .(site, ID_AF, variable)]

## reorder factors 

dataC_all$ID_AF <- factor(dataC_all$ID_AF, levels = c("CF", "SP", "YA", "HG", "FG"))

# uncertainty fig 2: bootstrap by MC iteration?

dataC_all[, variable := factor(variable, levels = c("meanAGC", "meanBGC", "meanSOC"))]
levels(dataC_all$variable) <- c("AGC", "BGC", "SOC")
dataC_all[, site := factor(site)]
levels(dataC_all$site) <- c("Gariuai", "Osso Luga")

ggplot(dataC_all, aes(x = ID_AF, y = value, fill = variable)) +
  geom_bar(position="stack", stat="identity") + 
  facet_wrap(~site, nrow = 1, strip.position = "bottom") +
  scale_fill_manual(values = c("forestgreen", "darkgoldenrod1", "coral4")) +
  theme_classic() +
  theme(strip.placement = "outside") +
  labs(x = "", y = "Carbon stocks (Mg C/ha)", fill = "Carbon\npool") +
  scale_y_continuous(expand = c(0, 0))
ggsave("figures/fig-carbon-stocks-stack.png", height = 5, width = 6)
```

```{r tab-3-reg, results = "show"}
## mixed effect linear regression
lmeReg <- lmerTest::lmer(log(meanSOC) ~ log(meanAGC) + (1|site), data = dataC)
# Nakagawa’s R2 for mixed models
R2 = performance::r2_nakagawa(lmeReg)
summary(lmeReg)

# same for topsoil layer (0-10 cm)
lmeReg10 <- lmerTest::lmer(log(SC10) ~ log(meanAGC) + (1|site), data = dataC)
# Nakagawa’s R2 for mixed models
R210 = performance::r2_nakagawa(lmeReg10)
summary(lmeReg10)

dfreg = 
  data.table(
    depth = c("Soil depth: 0-30 cm", "Soil depth: 0-10 cm"), 
    intercept = c(summary(lmeReg)$coefficients[1,1], summary(lmeReg10)$coefficients[1,1]), 
    slope = c(summary(lmeReg)$coefficients[2,1], summary(lmeReg10)$coefficients[2,1]), 
    pvalue = c(summary(lmeReg)$coefficients[2,5], summary(lmeReg10)$coefficients[2,5]),
    R2_cond = c(R2$R2_conditional, R210$R2_conditional), 
    R2_marg = c(R2$R2_marginal, R210$R2_marginal)
  )

```

```{r fig-3-reg, fig.height = 4, fig.width = 8}
dfpred = expand.grid(meanAGC = exp(seq(min(log(dataC$meanAGC), na.rm = TRUE),
                                       max(log(dataC$meanAGC), na.rm = TRUE),
                                       length.out = 20)),
                     depth = c("Soil depth: 0-30 cm", "Soil depth: 0-10 cm")) |>
  merge(dfreg[, c("depth", "intercept", "slope")], by = "depth")
setDT(dfpred)
dfpred[, meanSOC := exp(intercept + slope * log(meanAGC))]

# change site names
dataC[, site := factor(site)]
levels(dataC$site) <- c("Gariuai", "Osso Luga")

# stack data for figure
dataC_30 = dataC[, c("N_PLOT", "site", "ID_AF",  "meanAGC", "lwrAGC", "uprAGC", "meanSOC", "lwrSOC", "uprSOC")]
dataC_30$depth = "Soil depth: 0-30 cm"
dataC_10 = dataC[, c("N_PLOT", "site", "ID_AF",  "meanAGC", "lwrAGC", "uprAGC", "SC10", "lwrSOC10", "uprSOC10")]
dataC_10$depth = "Soil depth: 0-10 cm"
colnames(dataC_10) = colnames(dataC_30)
dataC_fig = rbind(dataC_10, dataC_30)

## figure
ggplot(dataC_fig, aes(color = ID_AF)) +
  geom_point(aes(x = meanAGC, y = meanSOC, shape = site), size = 2) +
  geom_text(data = dfreg, aes(label = paste0("R^{2}*' (marg.) = '*", round(R2_marg, 3))),
            x = -Inf, y = Inf, hjust = -0.1, vjust = 1.2, parse = TRUE, color = 1) +
  geom_text(data = dfreg, aes(label = paste0("R^{2}*' (cond.) = '*", round(R2_cond, 3))),
            x = -Inf, y = Inf, hjust = -0.1, vjust = 2.2, parse = TRUE, color = 1) +
  geom_linerange(aes(x = meanAGC, y = meanSOC, ymin = lwrSOC, ymax = uprSOC)) +
  geom_errorbarh(aes(y = meanSOC, xmin = lwrAGC, xmax = uprAGC)) +
  # geom_abline(data = dfreg, aes(intercept = intercept, slope = slope), lty = 2) +
  geom_line(data = dfpred, aes(x = meanAGC, y = meanSOC), lty = 2, col = 1) +
  labs(color = "AFS", x = "AGC stocks (Mg C/ha)", y = "SOC stocks (Mg C/ha)", shape = "Site") +
  expand_limits(x = 0, y = 0) +
  scale_color_manual(values = RColorBrewer::brewer.pal(n = 6, name = 'Dark2')[-5]) +
  # scale_x_continuous(expand = c(0, 0)) + scale_y_continuous(expand = c(0, 0)) +
  scale_x_log10() +
  scale_y_log10() +
  facet_wrap(~depth) +
  theme_classic()

ggsave("figures/fig-scatterplot-carbon.png", height = 4, width = 8)
```


## Total carbon stocks

Total carbon stocks varied between `r data_boot_tot[variable=="TOT", median(value), .(N_PLOT)][,round(min(V1))]` and `r data_boot_tot[variable=="TOT", median(value), .(N_PLOT)][,round(max(V1))]` Mg C/ha, with an average of `r data_boot_tot[variable=="TOT", median(value), .(N_PLOT)][,round(mean(V1))]` Mg C/ha and a coefficient of variation of `r data_boot_tot[variable=="TOT", median(value), .(N_PLOT)][,round(sd(V1)/mean(V1)*100)]`%  (Table 1; Figure 2). The AFS with the lowest total carbon stocks was the `r data_boot_tot[variable=="TOT", median(value), .(N_PLOT,ID_AF)][, ID_AF[which.min(V1)]]` with a median of `r data_boot_tot[variable=="TOT", mean(value), .(N_PLOT,ID_AF)][, round(min(V1))]` Mg C/ha; the AFS with the highest total carbon stocks was the `r data_boot_tot[variable=="TOT", median(value), .(N_PLOT,ID_AF)][, ID_AF[which.max(V1)]]` with a median of `r data_boot_tot[variable=="TOT", median(value), .(N_PLOT,ID_AF)][, round(max(V1))]` Mg C/ha (Table 1; Figure 2).

## Aboveground carbon

AGC stocks varied between `r dataC[, round(min(meanAGC, na.rm = TRUE))]` and `r dataC[, round(max(meanAGC, na.rm = TRUE))]` MgC/ha, with an average of `r dataC[, round(mean(meanAGC, na.rm = TRUE))]` MgC/ha and a coefficient of variation of `r dataC[, round(100*sd(meanAGC, na.rm = TRUE)/mean(meanAGC, na.rm = TRUE))]`%  (Table 1; Figure 2). In line with our hypothesis (H1a), AGC stocks varied significantly between AFS (ANOVA p-value: `r tab_anov$p[tab_anov$response=="AGC" & tab_anov$ind_var == "AF"]`), but not between site (ANOVA p-value = `r tab_anov$p[tab_anov$response=="AGC" & tab_anov$ind_var == "SUCO"]`, Table 2). The AFS with the lowest AGC stocks was the `r dataC[, mean(meanAGC, na.rm = TRUE), .(ID_AF)][, ID_AF[which.min(V1)]]` with an average of `r dataC[, mean(meanAGC, na.rm = TRUE), .(ID_AF)][, round(min(V1))]` Mg C/ha; the AFS with the highest AGC stocks was the `r dataC[, mean(meanAGC, na.rm = TRUE), .(ID_AF)][, ID_AF[which.max(V1)]]` with an average of `r dataC[, mean(meanAGC , na.rm = TRUE), .(ID_AF)][, round(max(V1))]` Mg C/ha (Table 1; Figure 2).

## Soil organic carbon

SOC stocks varied between `r dataC[, round(min(meanSOC, na.rm = TRUE))]` and `r dataC[, round(max(meanSOC, na.rm = TRUE))]` MgC/ha, with an average of `r dataC[, round(mean(meanSOC, na.rm = TRUE))]` MgC/ha and a coefficient of variation of `r dataC[, round(100*sd(meanSOC, na.rm = TRUE)/mean(meanSOC, na.rm = TRUE))]`%  (Table 1; Figure 2). In disagreement with our hypothesis (H1b), no significant differences in SOC were observed between the five AFS studied (ANOVA p-value: `r tab_anov$p[tab_anov$response=="SOC" & tab_anov$ind_var == "AF"]`). However, the measured SOC stocks differed from suco to suco (ANOVA p-value: `r tab_anov$p[tab_anov$response=="SOC" & tab_anov$ind_var == "SUCO"]`; Table 2). The SOC stocks in Gariuai were on average higher (`r dataC[ID_SUCO=="G", round(mean(meanSOC, na.rm = TRUE))]` Mg C/ha) than those in Osso Luga (`r dataC[ID_SUCO=="S", round(mean(meanSOC, na.rm = TRUE))]` Mg C/ha; Figure 2).

## Relationship between AGC and SOC

The relationship between AGC and SOC was not significant (p-value = `r round(dfreg$pvalue[grepl("30", dfreg$depth)], 2)`; Figure 3), as hypothesized (H2b). Contrary to our hypothesis (H2a), this relationship remained insignificant (p-value = `r round(dfreg$pvalue[grepl("10", dfreg$depth)], 2)`) when tested with SOC stocks in the topsoil layer (0-10 cm). The proportion of variance explained by the linear mixed models were `r round(dfreg$R2_cond[grepl("30", dfreg$depth)]*100)`% and `r round(dfreg$R2_cond[grepl("10", dfreg$depth)]*100)`% for 0-30 and 0-10 cm depths respectively, but a marginal R$^2$ of just `r round(dfreg$R2_marg[grepl("30", dfreg$depth)]*100, 1)`% and `r round(dfreg$R2_marg[grepl("10", dfreg$depth)]*100, 1)`% respectively when only the fixed effect was considered (Figure 3). Overall, AGC stocks were a poor predictor of SOC stocks.


# Supplementary material

![(#fig:design) Plot sampling design. (a) Typical plot < 1 ha, in all AFS except SP. (b) Typical 1-ha plot in SP systems. Red areas are the five 10x10 m subplots, and blue dots are the three soil sampling locations.](figures/plot-design.jpg)

```{r afs-typology}
typ = readxl::read_excel("tables/afs-typology.xlsx")
kable(typ)
```

```{r sfig-distr-sol, fig.height = 5, fig.width = 15}
## diagnostic données sol pour marguerite
g1 <- ggplot(data_soil, aes(x = CF*100, col = SAMPLE_DEPTH)) +
  geom_histogram(bins = 30) +
  geom_text(data = subset(data_soil, CF > 0.3), angle = -60,
            aes(x = CF*100-5, y = 15,
                label = paste("Site:", ID_VILLAGE, "/ SAF:", ID_TYPE, "/ Plot:", N_PLOT))) +
  labs(x = "Elements grossiers (% du volume)",
       y = "Nombre d'échantillons (site x profondeur)",
       col = "Profondeur (cm)") +
  scale_y_continuous(expand = expand_scale(0, 0)) +
  theme_classic()  +
  theme(legend.position = c(0.8, 0.9))

g2 <- ggplot(data_soil, aes(x = Corg, col = SAMPLE_DEPTH)) +
  geom_histogram(bins = 20) +
  labs(x = "Teneur en carbone (%)",
       y = "Nombre d'échantillons (site x profondeur)",
       col = "Profondeur (cm)") +
  scale_y_continuous(expand = expand_scale(0, 0)) +
  theme_classic() +
  theme(legend.position = c(0.8, 0.9))

g3 <- ggplot(data_soil, aes(x = BD, col = SAMPLE_DEPTH)) +
  geom_histogram(bins = 20) +
  labs(x = "Densité apparente",
       y = "Nombre d'échantillons (site x profondeur)",
       col = "Profondeur (cm)") +
  scale_y_continuous(expand = expand_scale(0, 0)) +
  theme_classic()+
  theme(legend.position = c(0.8, 0.9))

ggpubr::ggarrange(g1, g2, g3, labels = "auto", nrow = 1)
ggsave("figures/fig-distr-sol.png", height = 5, width = 15)
```

```{r sfig-clay-corg, fig.height = 4, fig.width = 6}
data_soil[, site := substr(ID_VILLAGE, 1, 1)]
data_soil[site == "S", site := "Osso Luga"]
data_soil[site == "G", site := "Gariuai"]


ggplot(data_soil[SAMPLE_DEPTH != "10-20"], aes(x = as.numeric(CLAY), y = Corg, col = SAMPLE_DEPTH)) +
  geom_point() +
  labs(col = "Soil depth (cm)", x = "Clay content (%)", y = "SOC content (%)") +
  scale_color_brewer(type = "qual") +
  scale_x_log10() + 
  scale_y_log10() +
  geom_smooth(method = "lm") +
  theme_classic()
ggsave("figures/fig-clay-corg.pdf", height = 4, width = 6)

lmerTest::lmer(
  log(Corg) ~ log(as.numeric(CLAY) + as.numeric(`FINE SILT`)) + 
    (1|site)+ 
    (1|SAMPLE_DEPTH), 
  data = data_soil[SAMPLE_DEPTH != "10-20"]) |> 
  summary()

ggplot(data_soil[SAMPLE_DEPTH != "10-20"], aes(x = as.numeric(CLAY) + as.numeric(`FINE SILT`), y = Corg, col = SAMPLE_DEPTH, shape = site)) +
  geom_point() +
  labs(col = "Soil depth (cm)", x = "Clay and fine silt content (%)", y = "SOC content (%)", shape = "Site") +
  scale_color_brewer(type = "qual") +
  # scale_x_log10() +
  # scale_y_log10() +
  # geom_smooth(method = "lm") +
  theme_classic()
ggsave("figures/fig-clay-silt-corg.png", height = 4, width = 6)
```

```{r test-ac-soc-by-depth}
data_soil_agc <- merge(data_soil[, c("N_PLOT", "SAMPLE_DEPTH", "Cstock")],
                       dataC[, c("N_PLOT","ID_AF", "ID_VILLAGE",  "meanAGC")], by = "N_PLOT")

ggplot(data_soil_agc, aes(x = meanAGC, y = Cstock, col = SAMPLE_DEPTH)) +
  geom_point() +
  geom_smooth(method = "lm")

lm(data = data_soil_agc, Cstock ~ meanAGC * SAMPLE_DEPTH) |> summary()
lm(data = data_soil_agc[SAMPLE_DEPTH == "0-10"], Cstock ~ meanAGC) |> summary()
lm(data = data_soil_agc[SAMPLE_DEPTH == "10-20"], Cstock ~ meanAGC ) |> summary()
lm(data = data_soil_agc[SAMPLE_DEPTH == "20-30"], Cstock ~ meanAGC ) |> summary()
```

```{r compare-lit-values}
litval <- read_excel("data/literature-values.xlsx")
colnames(litval) <- c("system", "pool", "value", "location", "ref")


litval$main_crop <- NA
litval$main_crop[grepl("palm", litval$system)] <- "oil palm"
litval$main_crop[grepl("offee", litval$system)] <- "coffee"
unique(litval$system[is.na(litval$main_crop)])

litval$main_per <- NA
litval$main_per[grepl("nset", litval$system)] <- "enset"
litval$main_per[grepl("Inga", litval$system)] <- "inga"
litval$main_per[grepl("Eucalyptus", litval$system)] <- "eucalyptus"
litval$main_per[grepl("Pinus", litval$system)] <- "pinus"
unique(litval$system[is.na(litval$main_per)])

litval$ID_AF <- NA
litval$ID_AF[grepl("orests|orest |orest$", litval$system)] <- "forest"
litval$ID_AF[grepl("onoculture", litval$system)] <- "monoculture"
litval$ID_AF[!is.na(litval$main_crop) & !is.na(litval$main_per)] <- "two-crops"
litval$ID_AF[grepl("ome garden", litval$system)] <- "HG"
unique(litval$system[is.na(litval$ID_AF)])

litval$var <- as.numeric(gsub(" ", "", tstrsplit(litval$value, "±")[[2]]))
litval$value <- gsub(" ", "", tstrsplit(litval$value, "±")[[1]])

mult_values <- which(sapply(strsplit(litval$value, ",|and"), length)>1)

new_rows = lapply(mult_values, function(i){
  vals = as.numeric(strsplit(litval$value[i], ",|and")[[1]])
  vals = vals[!is.na(vals)]
  
  x = matrix(litval[i,], ncol = ncol(litval), nrow = length(vals), byrow = TRUE)
  x[, colnames(litval) == "value"] = vals
  
  x = as.data.frame(x)
  colnames(x) = colnames(litval)
  return(x)
}
)

new_rows = do.call(rbind, new_rows)

litval2 = rbind(new_rows, litval[-mult_values,])
litval = data.frame(system = unlist(litval2$system),
                    pool = unlist(litval2$pool),
                    value = unlist(litval2$value),
                    location = unlist(litval2$location),
                    ref = unlist(litval2$ref),
                    main_crop = unlist(litval2$main_crop),
                    main_per = unlist(litval2$main_per),
                    ID_AF = unlist(litval2$ID_AF),
                    var = unlist(litval2$var))

```

### Effect of altitude on SOC stocks

```{r sfig-altitude}
dataCelev = merge(dataC[, c("N_PLOT", "meanSOC", "uprSOC", "lwrSOC")], 
                  data_plot[, c("N_PLOT", "elev", "site")], by = "N_PLOT")

lmerTest::lmer(log(meanSOC) ~ log(elev) + (1|site), data = dataCelev) |> 
  summary()

ggplot(dataCelev, aes(x = elev, y = meanSOC, col = site)) +
  geom_pointrange(aes(ymin=lwrSOC, ymax = uprSOC)) + 
  theme_classic() +
  labs(x = "Elevation (m)", y = "SOC stocks (Mg C/ha)", col = "Site")
ggsave("figures/soc-elev.png", height = 4, width = 6)
```


### Site soil characteristics

```{r stab-site-soil}
data_soil$silt <- as.numeric(data_soil$`FINE SILT`) + as.numeric(data_soil$`COARSE SILT`)
data_soil$sand <- as.numeric(data_soil$`FINE SAND`) + as.numeric(data_soil$`COARSE SAND`)

vars = c("Corg\n", "N", "Corg_N", "CLAY", "silt", "sand", "pH\n", "CA", "Mg", "K", "Na", "CEC")
data_soil_plot = melt(data_soil, id.vars = c("site", "N_PLOT", "SAMPLE_DEPTH"), 
                      measure.vars = c("Corg\n", "N", "Corg_N", "CLAY", "silt", "sand", "pH\n", "Ca", "Mg\n", "K", "Na", "CEC\n"))

data_soil_plot[, variable := gsub("\n", "", variable)]

# when value below detection limit: use half of detection value
data_soil_plot[grepl("LD", value), value := as.numeric(strsplit(value, "=")[[1]][2])/2]
data_soil_plot[, value := as.numeric(value)]

# remove NA values
data_soil_plot = subset(data_soil_plot, !is.na(value))

# simulation 100 values per plot, soil depth and variable with a 12% coefficient
# of variation (CV value from lab)
data_soil_plot_simu = 
  data_soil_plot[, .(
    value = rnorm(100, value, sd = 0.12*value), n = 1:100), 
    .(site, N_PLOT, SAMPLE_DEPTH, variable)]

# bootstrap plot values to get mean value at the site level (for each simulation)
data_soil_site_simu = 
  data_soil_plot_simu[, .(
    value = mean(sample(value, length(value), replace = TRUE))),
    .(site, variable, n)]

# calculate mean and 95% confidence interval at site level
data_soil_site  = data_soil_site_simu[, .(
  value = paste0(
    signif(mean(value), 3), " (",
    signif(quantile(value, 0.025), 3), "-", 
    signif(quantile(value, 0.975), 3), ")"
  )), 
  .(site, variable)]

# change table shape to have one column per variable
data_soil_site = dcast(data_soil_site, site ~ variable, value.var = "value")
data_soil_site = data_soil_site[, c("site", "CLAY", "silt", "sand", "Corg", "N", "Corg_N", "pH", "Ca", "K", "Mg", "Na", "CEC")]
colnames(data_soil_site) = c("Site", "Clay (%)", "Silt (%)", "Sand (%)", "SOC content (%)","N", "C/N", "pH", "Ca", "K", "Mg", "Na", "CEC")

write.csv(data_soil_site, "data/soil_site.csv", row.names = FALSE)
```

### Botanical identification from Tetum names

```{r tetum-names}
sheets1 = grep("INV", readxl::excel_sheets("data/DATA_BIOMASS_TL_LARGE.xlsx"), value = TRUE)
sheets2 = grep("INV", readxl::excel_sheets("data/DATA_BIOMASS_TL_SHORT.xlsx"), value = TRUE)

vern1 <- lapply(sheets1, \(x){
  df = readxl::read_excel("data/DATA_BIOMASS_TL_LARGE.xlsx", sheet = x)
  df = df[, c("TETUM_NAME", "SCIENTIFIC_NAME")] |>
    unique() |>  subset(!SCIENTIFIC_NAME %in% c("Unknown", "NR", "Unkown"))
})
vern2 <- lapply(sheets2, \(x){
  df = readxl::read_excel("data/DATA_BIOMASS_TL_LARGE.xlsx", sheet = x)
  df = df[, c("TETUM_NAME", "SCIENTIFIC_NAME")] |>
    unique() |>  subset(!SCIENTIFIC_NAME %in% c("Unknown", "NR", "Unkown"))
})

vern = rbind(rbindlist(vern1), rbindlist(vern2)) |>  unique()
vern <- subset(vern, !is.na(TETUM_NAME) & !is.na(SCIENTIFIC_NAME))

## correct scientific names
vern[, c("genus", "species") := tstrsplit(SCIENTIFIC_NAME, " ")[1:2]]
vern[species %in% c("sp", "sp."), species := NA]
vern[species == "purpuroides", species := NA]
corr = BIOMASS::correctTaxo(genus = vern$genus, species = vern$species)
vern = cbind(vern, corr)

vern[, latin := paste(genusCorrected, speciesCorrected)]
vern[, latin := gsub(" NA", " sp.", latin)]
vern[,tetum := gsub("  ", " ", tolower(TETUM_NAME))]
vern <- vern[, c("tetum", "latin", "genusCorrected", "speciesCorrected")]
vern = unique(vern)

# check that all names are unique
# if one tetum name has two levels of id (same genus), keep better identification
dupl_tetum <- vern[duplicated(tetum), unique(tetum)]
vern = vern[!(tetum %in% dupl_tetum & is.na(speciesCorrected))]
setorder(vern, tetum)

vern = vern[, .(latin = paste(latin, collapse = ", ")), .(tetum)]
write.csv(vern, "data/species-correspondance.csv", row.names = FALSE)
```

```{r timer-leste-c-footprint-lulcc}
df_eluc <- read_excel("C:/Users/piponiot-laroche/Downloads/National_LandUseChange_Carbon_Emissions_2023v1.0.xlsx", sheet = "OSCAR") 
colnames(df_eluc) <- df_eluc[7,]
df_eluc <- df_eluc[-(1:8),colnames(df_eluc) %in% c("unit: Tg C/year", "Timor-Leste")]
```

# References
