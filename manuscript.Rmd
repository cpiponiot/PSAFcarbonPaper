---
title: "Traditional agroforestry systems in Timor-Leste can store large amounts of carbon in both soil and biomass"
author: "Marguerite Cogné, Régis Peltier, Vincent Freycon, Alexis Toumazeau, Camille Piponiot"
date: "2023-05-10"
output: 
  bookdown::word_document2:
  fig_caption: yes
bibliography: references.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message=FALSE, results = "hide", tinytex.clean = FALSE)
packages_needed = c("ggplot2", "dataverse", "readxl", "data.table")

packages_to_install = packages_needed[!( packages_needed %in% rownames(installed.packages()))]

if (length(packages_to_install) > 0)
  install.packages(packages_to_install)

lapply(packages_needed, require, character.only = TRUE)
```

# Introduction

Agricultural expansion has been the main driver of tropical deforestation over the past half century [@Pendrill2022;@Gibbs2010;@Rudel2009], resulting in large greenhouse gas emissions [approximately 2.6 gigatonnes CO_2_e/yr over 2010-2014; @Pendrill2019]. The demand for tropical agricultural land is expected to continue to increase in the tropics as the population grows [@UN2022]. In addition, tropical areas are expected to be disproportionately affected by deforestation and climate change, putting their agriculture at risk [@Lawrence2015]. There is therefore an urgent need to promote tropical agricultural landscapes that are both more resilient to climate change, while maintaining high productivity and ecological value [@Harvey2014]. In particular, increasing the carbon stored in the soil and vegetation of agricultural landscapes could be an effective way to mitigate climate change while increasing the resilience of the food production system [@Lal2004].

Agroforestry has attracted attention in recent decades as a set of effective agricultural practices that could contribute to climate change mitigation and adaptation [@Verchot2007]. Agroforestry is a collective name for land use systems and technologies where woody perennials (trees, shrubs, palms, bamboo, etc.) are deliberately used on the same land management units as agricultural crops and/or animals, in some form of spatial arrangement or temporal sequence [@Lundgren1982]. Agroforestry allows for diversification of agricultural production, making agricultural systems more resilient [@Duffy2021]; it also increases the carbon sequestration in the vegetation but also in the soil [@DeStefano2018].  


Carbon stocks in AFS [VF]

Importance of the ecological/social context in the success of agroforestry techniques - existence of traditional agroforestry techniques that could be more adapted to local conditions, [MC]
Agroforestry needs to be adapted to the context [(Coe et al., 2014, Cur Opinion in Env Sust) @Coe2014]

Existence of traditional agroforestry systems [examples from Marguerite’s intro]

Context in Timor Leste: current knowledge on their agroforestry practices + knowledge gap [MC]

Local typology of production systems and why it is not adapted to traditional agroforestry

No prior description of traditional agroforestry systems in TL

In Timor Leste, a typology of production systems taking into account different agroecological zoning was carried out in 2017 based on the results of the 2010 national census (R. Williams et al, 2018). However, this typology does not highlight the agroforestry component of Timorese agriculture by focusing on other differentiating criteria such as livestock, subsistence crops (rice) or the island's historical cash crops (coconut, coffee).

Need to better understand how these systems work and quantify their carbon storage to include them in climate change mitigation policies 
Research questions  [VF]

What are the characteristics of traditional agroforestry systems in Timor Leste? 

How much carbon do they store in both their biomass and in the soil

Are there measurable differences between AFS?

Hypotheses [VF]

Proposition: lien entre typologie et stocks de carbone

# Materials and methods

```{r download-data}
## download data from dataverse - once published
dataverse_url <- "https://dataverse.cirad.fr/privateurl.xhtml?token=f8eabb2a-3635-499b-aee5-80fd2b7495a0"
dataverse_doi <- "10.18167/DVN1/QCXWIY"

# for now : download manually from temporary link
# utils::unzip("dataverse_files.zip")
``` 

```{r agb-calculation}
# get agb data
source("script-agb.R")
```

```{r open-soil-data}
# open organic carbon data
# bulk density in Gariuai according to SoilGrids = 125 cg/cm3
data_soil <- readxl::read_excel("data/RESUME_DATA_SOIL_SHORT_TL.xls", sheet = "RESUME-LAB ")

# add bulk density and coarse fraction
data_soil2 <- readxl::read_excel("data/RAW_DATA_SOIL_LARGE_TL.xls", sheet = "SAMPLING_MEASURE")

# bulk density from direct measurements
data_soil2$BD <- data_soil2$Sample_DRY/data_soil2$V_cylinder

# coarse fraction
data_soil2$CF <- data_soil2$V_rocks_tot/data_soil2$V_cylinder

# change format of depth to correspond to other soil table
data_soil2$SAMPLE_DEPTH <- factor(data_soil2$DEPTH_SAMPLE_C, levels = c("2_7", "12_17", "22_27"))
levels(data_soil2$SAMPLE_DEPTH) <- c("0-10", "10-20", "20-30")

data_soil <- merge(data_soil, data_soil2, by = c("N_PLOT", "SAMPLE_DEPTH"), all=TRUE)
data.table::setDT(data_soil)
```

```{r add-missing-values}
## add intermediate soil carbon in 10-20 cm depth (for now: no value)
data_soil[, Corg := mean(`Corg\n`, na.rm = TRUE), .(N_PLOT)]
data_soil[!is.na(`Corg\n`), Corg := `Corg\n`]

# replace one missing value of coarse fraction with plot level mean
data_soil[, CF_site := mean(CF, na.rm = TRUE), .(N_PLOT)]
data_soil[is.na(CF), CF := CF_site]
```

```{r total-soc}
# calculate total soil carbon stock per depth
data_soil[, c("h0", "h1") := lapply(data.table::tstrsplit(SAMPLE_DEPTH, "-"), as.numeric)]
data_soil[, Cstock :=             ## in Mg/ha
            (h1 - h0) * 1e8 *     ## equivalent volume of a 1 ha soil sample, in cm3/ha
            Corg/100 *            ## carbon organic content in fine soil (unitless)
            (Sample_DRY * 1e-6) * ## mass of the fine fraction of the soil (Mg)
            (1/V_cylinder)        ## 1/volume of the cylinder, in cm-3
]

data_soil_C <-
  data_soil[, .(
    meanSOC = sum(Cstock),
    SC10 = Cstock[SAMPLE_DEPTH == "0-10"],
    clay = mean(as.numeric(CLAY), na.rm = TRUE)
  ), .(N_PLOT)]

setkey(data_soil_C, "N_PLOT")
```

```{r soc-error-propagation}
## error propagation using a Monte Carlo method -------------
data_soil_unc = data_soil[, .(mass = rnorm(1000, Sample_DRY, Sample_DRY*0.1), 
                              Corg = rnorm(1000, Corg, Corg*0.12), 
                              iter = 1:1000), 
                          .(N_PLOT, SAMPLE_DEPTH, h1, h0)]

data_soil_unc = data_soil_unc[, .(
  Cstock = sum((h1 - h0) * 1e8 / 250 * Corg/100 * (mass * 1e-6)), 
  Cstock10 = ((h1 - h0) * 1e8 / 250 * Corg/100 * (mass * 1e-6))[SAMPLE_DEPTH == "0-10"]),
  .(N_PLOT, iter)
]

data_soil_quantile = data_soil_unc[, .(
  lwrSOC = quantile(Cstock, 0.025), 
  medSOC = quantile(Cstock10, 0.5),
  uprSOC = quantile(Cstock, 0.975),
  lwrSOC10 = quantile(Cstock10, 0.025), 
  medSOC10 = quantile(Cstock10, 0.5),
  uprSOC10 = quantile(Cstock10, 0.975)), 
  .(N_PLOT)]
```

```{r combine-agb-soc-data}
# combine AGB and soil C
dataC <- merge(data_agb, data_soil_C, by = "N_PLOT", all=TRUE)

# add soil carbon uncertainty
dataC <- merge(dataC, data_soil_quantile, all=TRUE)

dataC[N_PLOT==6, `:=`(ID_VILLAGE = "GD", ID_AF = "CF")]

dataC[, village := substr(ID_VILLAGE, 1, 1)]
dataC$ID_AF <- factor(dataC$ID_AF, levels = c("CF", "SP", "YA", "HG", "FG"))
```

# Results

```{r tab-median, results = "show"}

## bootstrapping 

#1. prepare data
data_agc_boot = melt(data_agb_unc, 
                       measure.vars = c("AGC", "BGC"), 
                       id.vars = c("ID_VILLAGE", "N_PLOT", "ID_AF", "iter"))

data_soil_boot = data_soil_unc[, c("N_PLOT", "iter", "Cstock")]
colnames(data_soil_boot)[3] = "value"
data_soil_boot$variable = "SOC"
data_soil_boot$iter = paste0("V", data_soil_boot$iter)

data_soil_boot = merge(data_soil_boot, data_plot[, c("N_PLOT","ID_VILLAGE", "ID_AF")])
    
data_boot = rbind(data_agc_boot, data_soil_boot[, colnames(data_agc_boot), with = FALSE])  

# 2. add total stocks
data_boot_tot = data_boot[, .(value = sum(value), variable = "TOT"), .(ID_VILLAGE, N_PLOT, ID_AF, iter)]
data_boot = rbind(data_boot, data_boot_tot[, colnames(data_boot), with = FALSE])

data_boot[, village := substr(ID_VILLAGE, 1, 1)]

# 3. bootstrap
data_boot_saf = data_boot[, .(value = mean(sample(value, length(value), replace = TRUE))),
    .(ID_AF, variable, iter)]

# calculate median and 95% confidence interval at site level
data_boot_saf  = data_boot_saf[, .(
  value = paste0(
  signif(mean(value), 3), " (",
  signif(quantile(value, 0.025), 3), "-", 
  signif(quantile(value, 0.975), 3), ")"
  )), 
  .(ID_AF, variable)]

data_boot_saf = dcast(data_boot_saf, ID_AF ~ variable, value = "value")


knitr::kable(data_boot_saf, col.names = c("Agroforestry system", "Aboveground carbon (MgC/ha)", "Belowground carbon (MgC/ha)", "Soil organic carbon (MgC/ha)", "Total carbon (MgC/ha)"))
write.csv(data_boot_saf, file = "tables/C_median_SAF.csv", row.names = FALSE)
```

```{r group-comparison}
dataC[, ID_SUCO := substr(ID_VILLAGE, 1, 1)]
## test normality of the data

# log-transform data to get normal distributions (because strictly positive data)
hist((dataC$meanAGC), breaks = 20)
hist((dataC$meanSOC))

# test normality
dataC[, .(
  shap.A = shapiro.test(log(medAGC))$p.value, 
  shap.S = shapiro.test(log(medSOC))$p.value
  ), .(ID_AF, ID_SUCO)]
# levene test of homoscedasticity
library(car)
dataC[, leveneTest(log(medAGC) ~ ID_AF*ID_SUCO)]$`Pr(>F)`[1]
dataC[, leveneTest(log(medSOC) ~ ID_AF*ID_SUCO)]$`Pr(>F)`[1]

# # pairwise group comparison with Tukey HSD method
# # https://arc.lib.montana.edu/book/statistics-with-r-textbook/item/59
# library(multcomp)
# aovAGC = aov(meanAGC ~ ID_AF, data = dataC)
# tuk <- glht(aovAGC, linfct = mcp(ID_AF = "Tukey"))
# summary(tuk)          # standard display
# tuk.cld <- cld(tuk)   # letter-based display
# 
# plot(tuk.cld)

# # soc
# aovSOC = aov(meanSOC ~ ID_AF, data = dataC)
# tuk <- glht(aovSOC, linfct = mcp(ID_AF = "Tukey"))
# summary(tuk)          # standard display
# tuk.cld <- cld(tuk)   # letter-based display
# 
# opar <- par(mai=c(1,1,1.5,1))
# plot(tuk.cld)

## non parametric test
#updated translation of help page implementation of Nemenyi-Damico-Wolfe-Dunn test
# library(coin)
# is.factor(dataC$ID_AF)
# NDWD <-
#   independence_test(meanAGC ~ ID_AF, data = dataC)
# , distribution = approximate(B = 10000),
# ytrafo = function(data) trafo(data, numeric_trafo = rank_trafo),
# xtrafo = mcp_trafo(iv = "Tukey"))

### global p-value
# print(pvalue(NDWD))
```


```{r tab-anova, results = "show"}
# 2-way anova 
dataC[, ID_SUCO := substr(ID_VILLAGE, 1, 1)]
anov1 = anova(lm(log(medAGC)~ID_SUCO+ID_AF, data = dataC))
anov2 = anova(lm(log(medSOC)~ID_SUCO+ID_AF, data = dataC))
tab_anov = data.frame(response = rep(c("AGC", "SOC"), each = 2), 
                      ind_var = rep(c("SUCO", "AF"), 2), 
                      p = round(c(anov1$`Pr(>F)`[1:2], anov2$`Pr(>F)`[1:2]), 3)
)

knitr::kable(tab_anov)
write.csv(tab_anov, file = "tables/anov.csv", row.names = FALSE)

## non parametric 2 way anova: anova on ranks
# anov1 = anova(lm(rank(meanAGC)~ID_SUCO+ID_AF, data = dataC))
# anov2 = anova(lm(rank(meanSOC)~ID_SUCO+ID_AF, data = dataC))
# tab_anov = data.frame(response = rep(c("AGC", "SOC"), each = 2), 
#                       ind_var = rep(c("SUCO", "AF"), 2), 
#                       p = round(c(anov1$`Pr(>F)`[1:2], anov2$`Pr(>F)`[1:2]), 3)
# )

```

```{r fig-1-map, fig.height =6, fig.width = 7}
## 2. Load data from excel file ####
data_coord <- read_xlsx("data/DATA_BIOMASS_TL_LARGE.xlsx", sheet = "GPS")
data.table::setDT(data_coord)

data_coord[, N_PLOT := as.numeric(data.table::tstrsplit(N_Q_ID, "_")[[1]])]

data_coord <- data_coord[, .(long = mean(as.numeric(LONG)), lat = mean(as.numeric(LAT))), .(N_PLOT)]

data_plot <- readxl::read_excel("data/DATA_BIOMASS_TL_SHORT.xlsx", "PLOT_GENERAL_INFO")

data_plot <- merge(data_coord, data_plot[, c("N_PLOT", "ID_VILLAGE", "ID_AF")])

data_plot[, village := substr(ID_VILLAGE, 1, 1)]
data_plot[village == "S", village := "Osso Luga"]
data_plot[village == "G", village := "Gariuai"]

data_box = data_plot[, .(xc = mean(long), yc = mean(lat)), .(village)]
data_box[village == "Gariuai", `:=`(w = 0.1, xc = xc + 0.001)]
data_box[village == "Osso Luga", w := 0.05]
data_box[, `:=`(x1 = xc - w/2, x2 = xc + w/2, y1 = yc - w/2, y2 = yc + w/2)]

## create Timor map ####

bbox <- c(124.5, -9.2, 127.5,  -8.3)
# basemap <- ggmap::get_stamenmap(bbox, maptype = "terrain", zoom = 10)

# geodata::elevation_3s(lon= c(data_box[village == "Osso Luga"]$x1), 
#                       lat= c(data_box[village == "Osso Luga"]$y1), 
#                       path = "data")
timor_map <- map_data("world", region = "Timor-Leste")

g1 = ggplot(timor_map) + 
  annotate(geom = "text", label = "a", x = -Inf, y = Inf, 
           hjust = 0, vjust = 1, fontface = "bold", size = 6) + 
  geom_polygon(aes(x = long, y = lat, group = group), fill="lightgray", colour = "grey") +
  geom_tile(data = data_box, aes(x = xc, y = yc, width = w, height = w), fill = NA, color = 1, linewidth = 0.5) +
  ggrepel::geom_text_repel(data = data_box, aes(x = xc, y = yc, label = village)) + 
  labs(x = "", y = "") +
  theme(legend.position = "top", axis.title = element_blank(), 
        axis.ticks = element_blank(), axis.text = element_blank(), 
        panel.background = element_blank())+
  coord_sf(crs = 'WGS84')


# get elevation information
elev = as.data.frame(terra::rast("data/srtm_62_14.tif"), xy = TRUE)
elevS <- subset(elev, x > data_box[village == "Osso Luga"]$x1 & 
                  x < data_box[village == "Osso Luga"]$x2 & 
                  y > data_box[village == "Osso Luga"]$y1 & 
                  y < data_box[village == "Osso Luga"]$y2)
elevS$village = "Osso Luga"
elevG <- subset(elev, x > data_box[village == "Gariuai"]$x1 & 
                  x < data_box[village == "Gariuai"]$x2 & 
                  y > data_box[village == "Gariuai"]$y1 & 
                  y < data_box[village == "Gariuai"]$y2)
elevG$village = "Gariuai"

elevAll = rbind(elevS, elevG)

## Map of villages and plots with elevation
g2 = 
  ggplot(data = elevAll) +
  geom_raster(aes(x = x, y = y, fill=srtm_62_14)) +
  geom_point(data = data_plot, 
             aes(x = long, y = lat, color = ID_AF), size = 2) + 
  geom_point(data = data_plot, 
             aes(x = long, y = lat), shape = 1, size = 2) + 
  # coord_equal() +
  # viridis::scale_fill_viridis(option = "D",
  #                             limits = range(c(elevS$srtm_62_14, elevG$srtm_62_14))
  # ) +
  scale_fill_gradientn(colours = terrain.colors(10)) +
  scale_color_manual(values = RColorBrewer::brewer.pal(n = 6, name = 'Dark2')[-5]) +
  labs(x = NULL, y = NULL, color = NULL, fill="Elevation (m)") +
  annotate(geom = "text", label = "b", x = -Inf, y = Inf, 
           hjust = -0.5, vjust = 1, fontface = "bold", size = 6) + 
  annotate(geom = "text", label = "c", x = Inf, y = -Inf, 
           hjust = 12, vjust = -9.8, fontface = "bold", size = 6) + 
  guides(color = FALSE, fill=guide_colorbar(title.position = "top")) +
  theme(legend.position = c(0.8, 0.85), legend.direction="horizontal", 
        axis.title = element_blank(),
        # axis.ticks = element_blank(), axis.text = element_blank(), 
        plot.title = element_text(hjust = 0.5), 
        panel.background = element_blank()) +
  scale_x_continuous(expand = c(0, 0)) + scale_y_continuous(expand = c(0, 0))+
  ggspatial::annotation_scale() +
  coord_sf(crs = 'WGS84')

# get AFS legend
g3 = ggplot(data_plot) +
  geom_point(aes(x = long, y = lat, color = ID_AF)) + 
  labs(color = "AFS") +
  guides(color=guide_legend(ncol=2)) +
  scale_color_manual(values = RColorBrewer::brewer.pal(n = 6, name = 'Dark2')[-5]) +
  theme_classic()
l1 = ggpubr::get_legend(g3)

ggpubr::ggarrange(ggpubr::ggarrange(g1, l1), g2, ncol = 1, heights = c(1,2))


ggsave("figures/mapPlotsSRTM.png", height =4.5, width = 6)


# extract elevation and rainfall for the 2 villages
data_plot$prec <- terra::extract(
  terra::rast("D:/maps/CHELSA/CHELSA_bio12_1981-2010_V.2.1.tif"), 
  cbind(data_plot$long, data_plot$lat)
)
data_plot$elev <- terra::extract(
  terra::rast("data/srtm_62_14.tif"), 
  cbind(data_plot$long, data_plot$lat)
)
data_plot[, ID_SUCO := substr(ID_VILLAGE, 1, 1)]
data_plot[, .(prec = mean(prec), range_prec = paste(range(prec), collapse = " - ")), .(ID_SUCO)]
data_plot[, .(elev = mean(elev), range_elev = paste(range(elev), collapse = " - ")), .(ID_SUCO)]
```

```{r fig-2-barplot, fig.height = 5, fig.width = 6}
## melt data.table
dataC_all <- melt(dataC, id.vars = c("N_PLOT", "ID_VILLAGE", "ID_AF", "village"), 
                  measure.vars = c("meanAGC", "meanBGC", "meanSOC"))

dataC_all <- dataC_all[, .(value = mean(value, na.rm = TRUE)), .(village, ID_AF, variable)]

## reorder factors 

dataC_all$ID_AF <- factor(dataC_all$ID_AF, levels = c("CF", "SP", "YA", "HG", "FG"))

# uncertainty fig 2: bootstrap by MC iteration?

dataC_all[, variable := factor(variable, levels = c("meanAGC", "meanBGC", "meanSOC"))]
levels(dataC_all$variable) <- c("AGC", "BGC", "SOC")
dataC_all[, village := factor(village)]
levels(dataC_all$village) <- c("Gariuai", "Osso Luga")

ggplot(dataC_all, aes(x = ID_AF, y = value, fill = variable)) +
  geom_bar(position="stack", stat="identity") + 
  facet_wrap(~village, nrow = 1, strip.position = "bottom") +
  scale_fill_manual(values = c("forestgreen", "darkgoldenrod1", "coral4")) +
  theme_classic() +
  theme(strip.placement = "outside") +
  labs(x = "", y = "Carbon stocks (Mg C/ha)", fill = "Carbon\npool") +
  scale_y_continuous(expand = c(0, 0))
ggsave("figures/fig-carbon-stocks-stack.png", height = 5, width = 6)
```

```{r tab-3-reg, results = "show"}
## mixed effect linear regression
lmeReg <- lmerTest::lmer(log(meanSOC) ~ log(meanAGC) + (1|village), data = dataC)
# Nakagawa’s R2 for mixed models
R2 = performance::r2_nakagawa(lmeReg)
summary(lmeReg)

# same for topsoil layer (0-10 cm)
lmeReg10 <- lmerTest::lmer(log(SC10) ~ log(meanAGC) + (1|village), data = dataC)
# Nakagawa’s R2 for mixed models
R210 = performance::r2_nakagawa(lmeReg10)
summary(lmeReg10)

dfreg = 
  data.table(
    depth = c("Soil depth: 0-30 cm", "Soil depth: 0-10 cm"), 
    intercept = c(summary(lmeReg)$coefficients[1,1], summary(lmeReg10)$coefficients[1,1]), 
    slope = c(summary(lmeReg)$coefficients[2,1], summary(lmeReg10)$coefficients[2,1]), 
    pvalue = c(summary(lmeReg)$coefficients[2,5], summary(lmeReg10)$coefficients[2,5]),
    R2_cond = c(R2$R2_conditional, R210$R2_conditional), 
    R2_marg = c(R2$R2_marginal, R210$R2_marginal)
  )

```

```{r fig-3-reg, fig.height = 4, fig.width = 8}
dfpred = expand.grid(meanAGC = exp(seq(min(log(dataC$meanAGC), na.rm = TRUE),
                                       max(log(dataC$meanAGC), na.rm = TRUE),
                                       length.out = 20)),
                     depth = c("Soil depth: 0-30 cm", "Soil depth: 0-10 cm")) |>
  merge(dfreg[, c("depth", "intercept", "slope")], by = "depth")
setDT(dfpred)
dfpred[, meanSOC := exp(intercept + slope * log(meanAGC))]

# change village names
dataC[, village := factor(village)]
levels(dataC$village) <- c("Gariuai", "Osso Luga")

# stack data for figure
dataC_30 = dataC[, c("N_PLOT", "village", "ID_AF",  "meanAGC", "lwrAGC", "uprAGC", "meanSOC", "lwrSOC", "uprSOC")]
dataC_30$depth = "Soil depth: 0-30 cm"
dataC_10 = dataC[, c("N_PLOT", "village", "ID_AF",  "meanAGC", "lwrAGC", "uprAGC", "SC10", "lwrSOC10", "uprSOC10")]
dataC_10$depth = "Soil depth: 0-10 cm"
colnames(dataC_10) = colnames(dataC_30)
dataC_fig = rbind(dataC_10, dataC_30)

## figure
ggplot(dataC_fig, aes(color = ID_AF)) +
  geom_point(aes(x = meanAGC, y = meanSOC, shape = village), size = 2) +
  geom_text(data = dfreg, aes(label = paste0("R^{2}*' (marg.) = '*", round(R2_marg, 3))),
            x = -Inf, y = Inf, hjust = -0.1, vjust = 1.2, parse = TRUE, color = 1) +
  geom_text(data = dfreg, aes(label = paste0("R^{2}*' (cond.) = '*", round(R2_cond, 3))),
            x = -Inf, y = Inf, hjust = -0.1, vjust = 2.2, parse = TRUE, color = 1) +
  geom_linerange(aes(x = meanAGC, y = meanSOC, ymin = lwrSOC, ymax = uprSOC)) +
  geom_errorbarh(aes(y = meanSOC, xmin = lwrAGC, xmax = uprAGC)) +
  # geom_abline(data = dfreg, aes(intercept = intercept, slope = slope), lty = 2) +
  geom_line(data = dfpred, aes(x = meanAGC, y = meanSOC), lty = 2, col = 1) +
  labs(color = "AFS", x = "AGC stocks (Mg C/ha)", y = "SOC stocks (Mg C/ha)", shape = "Site") +
  expand_limits(x = 0, y = 0) +
  scale_color_manual(values = RColorBrewer::brewer.pal(n = 6, name = 'Dark2')[-5]) +
  # scale_x_continuous(expand = c(0, 0)) + scale_y_continuous(expand = c(0, 0)) +
  scale_x_log10() +
  scale_y_log10() +
  facet_wrap(~depth) +
  theme_classic()

ggsave("figures/fig-scatterplot-carbon.png", height = 4, width = 8)
```


## Total carbon stocks

Total carbon stocks varied between `r data_boot_tot[variable=="TOT", median(value), .(N_PLOT)][,round(min(V1))]` and `r data_boot_tot[variable=="TOT", median(value), .(N_PLOT)][,round(max(V1))]` Mg C/ha, with an average of `r data_boot_tot[variable=="TOT", median(value), .(N_PLOT)][,round(mean(V1))]` Mg C/ha and a coefficient of variation of `r data_boot_tot[variable=="TOT", median(value), .(N_PLOT)][,round(sd(V1)/mean(V1)*100)]`%  (Table 1; Figure 2). The AFS with the lowest total carbon stocks was the `r data_boot_tot[variable=="TOT", median(value), .(N_PLOT,ID_AF)][, ID_AF[which.min(V1)]]` with a median of `r data_boot_tot[variable=="TOT", mean(value), .(N_PLOT,ID_AF)][, round(min(V1))]` Mg C/ha; the AFS with the highest total carbon stocks was the `r data_boot_tot[variable=="TOT", median(value), .(N_PLOT,ID_AF)][, ID_AF[which.max(V1)]]` with a median of `r data_boot_tot[variable=="TOT", median(value), .(N_PLOT,ID_AF)][, round(max(V1))]` Mg C/ha (Table 1; Figure 2).

## Aboveground carbon

AGC stocks varied between `r dataC[, round(min(meanAGC, na.rm = TRUE))]` and `r dataC[, round(max(meanAGC, na.rm = TRUE))]` MgC/ha, with an average of `r dataC[, round(mean(meanAGC, na.rm = TRUE))]` MgC/ha and a coefficient of variation of `r dataC[, round(100*sd(meanAGC, na.rm = TRUE)/mean(meanAGC, na.rm = TRUE))]`%  (Table 1; Figure 2). In line with our hypothesis (H1a), AGC stocks varied significantly between AFS (ANOVA p-value: `r tab_anov$p[tab_anov$response=="AGC" & tab_anov$ind_var == "AF"]`), but not between site (ANOVA p-value = `r tab_anov$p[tab_anov$response=="AGC" & tab_anov$ind_var == "SUCO"]`, Table 2). The AFS with the lowest AGC stocks was the `r dataC[, mean(meanAGC, na.rm = TRUE), .(ID_AF)][, ID_AF[which.min(V1)]]` with an average of `r dataC[, mean(meanAGC, na.rm = TRUE), .(ID_AF)][, round(min(V1))]` Mg C/ha; the AFS with the highest AGC stocks was the `r dataC[, mean(meanAGC, na.rm = TRUE), .(ID_AF)][, ID_AF[which.max(V1)]]` with an average of `r dataC[, mean(meanAGC , na.rm = TRUE), .(ID_AF)][, round(max(V1))]` Mg C/ha (Table 1; Figure 2).

## Soil organic carbon

SOC stocks varied between `r dataC[, round(min(meanSOC, na.rm = TRUE))]` and `r dataC[, round(max(meanSOC, na.rm = TRUE))]` MgC/ha, with an average of `r dataC[, round(mean(meanSOC, na.rm = TRUE))]` MgC/ha and a coefficient of variation of `r dataC[, round(100*sd(meanSOC, na.rm = TRUE)/mean(meanSOC, na.rm = TRUE))]`%  (Table 1; Figure 2). In disagreement with our hypothesis (H1b), no significant differences in SOC were observed between the five AFS studied (ANOVA p-value: `r tab_anov$p[tab_anov$response=="SOC" & tab_anov$ind_var == "AF"]`). However, the measured SOC stocks differed from suco to suco (ANOVA p-value: `r tab_anov$p[tab_anov$response=="SOC" & tab_anov$ind_var == "SUCO"]`; Table 2). The SOC stocks in Gariuai were on average higher (`r dataC[ID_SUCO=="G", round(mean(meanSOC, na.rm = TRUE))]` Mg C/ha) than those in Osso Luga (`r dataC[ID_SUCO=="S", round(mean(meanSOC, na.rm = TRUE))]` Mg C/ha; Figure 2).

## Relationship between AGC and SOC

The relationship between AGC and SOC was not significant (p-value = `r round(dfreg$pvalue[grepl("30", dfreg$depth)], 2)`; Figure 3), as hypothesized (H2b). Contrary to our hypothesis (H2a), this relationship remained insignificant (p-value = `r round(dfreg$pvalue[grepl("10", dfreg$depth)], 2)`) when tested with SOC stocks in the topsoil layer (0-10 cm). The proportion of variance explained by the linear mixed models were `r round(dfreg$R2_cond[grepl("30", dfreg$depth)]*100)`% and `r round(dfreg$R2_cond[grepl("10", dfreg$depth)]*100)`% for 0-30 and 0-10 cm depths respectively, but a marginal R$^2$ of just `r round(dfreg$R2_marg[grepl("30", dfreg$depth)]*100, 1)`% and `r round(dfreg$R2_marg[grepl("10", dfreg$depth)]*100, 1)`% respectively when only the fixed effect was considered (Figure 3). Overall, AGC stocks were a poor predictor of SOC stocks.


# Supplementary material

```{r sfig-distr-sol, fig.height = 5, fig.width = 15}
## diagnostic données sol pour marguerite
g1 <- ggplot(data_soil, aes(x = CF*100, col = SAMPLE_DEPTH)) +
  geom_histogram(bins = 30) +
  geom_text(data = subset(data_soil, CF > 0.3), angle = -60,
            aes(x = CF*100-5, y = 15,
                label = paste("Village:", ID_VILLAGE, "/ SAF:", ID_TYPE, "/ Plot:", N_PLOT))) +
  labs(x = "Elements grossiers (% du volume)",
       y = "Nombre d'échantillons (site x profondeur)",
       col = "Profondeur (cm)") +
  scale_y_continuous(expand = expand_scale(0, 0)) +
  theme_classic()  +
  theme(legend.position = c(0.8, 0.9))

g2 <- ggplot(data_soil, aes(x = Corg, col = SAMPLE_DEPTH)) +
  geom_histogram(bins = 20) +
  labs(x = "Teneur en carbone (%)",
       y = "Nombre d'échantillons (site x profondeur)",
       col = "Profondeur (cm)") +
  scale_y_continuous(expand = expand_scale(0, 0)) +
  theme_classic() +
  theme(legend.position = c(0.8, 0.9))

g3 <- ggplot(data_soil, aes(x = BD, col = SAMPLE_DEPTH)) +
  geom_histogram(bins = 20) +
  labs(x = "Densité apparente",
       y = "Nombre d'échantillons (site x profondeur)",
       col = "Profondeur (cm)") +
  scale_y_continuous(expand = expand_scale(0, 0)) +
  theme_classic()+
  theme(legend.position = c(0.8, 0.9))

ggpubr::ggarrange(g1, g2, g3, labels = "auto", nrow = 1)
ggsave("figures/fig-distr-sol.png", height = 5, width = 15)
```

```{r sfig-clay-corg, fig.height = 4, fig.width = 6}
data_soil[, village := substr(ID_VILLAGE, 1, 1)]
data_soil[village == "S", village := "Osso Luga"]
data_soil[village == "G", village := "Gariuai"]


ggplot(data_soil[SAMPLE_DEPTH != "10-20"], aes(x = as.numeric(CLAY), y = Corg, col = SAMPLE_DEPTH)) +
  geom_point() +
  labs(col = "Soil depth (cm)", x = "Clay content (%)", y = "SOC content (%)") +
  scale_color_brewer(type = "qual") +
  scale_x_log10() + 
  scale_y_log10() +
  geom_smooth(method = "lm") +
  theme_classic()
ggsave("figures/fig-clay-corg.pdf", height = 4, width = 6)

lmerTest::lmer(
  log(Corg) ~ log(as.numeric(CLAY) + as.numeric(`FINE SILT`)) + 
     (1|village)+ 
     (1|SAMPLE_DEPTH), 
   data = data_soil[SAMPLE_DEPTH != "10-20"]) |> 
  summary()

ggplot(data_soil[SAMPLE_DEPTH != "10-20"], aes(x = as.numeric(CLAY) + as.numeric(`FINE SILT`), y = Corg, col = SAMPLE_DEPTH, shape = village)) +
  geom_point() +
  labs(col = "Soil depth (cm)", x = "Clay and fine silt content (%)", y = "SOC content (%)", shape = "Site") +
  scale_color_brewer(type = "qual") +
  # scale_x_log10() +
  # scale_y_log10() +
  # geom_smooth(method = "lm") +
  theme_classic()
ggsave("figures/fig-clay-silt-corg.png", height = 4, width = 6)
```

```{r test-ac-soc-by-depth}
data_soil_agc <- merge(data_soil[, c("N_PLOT", "SAMPLE_DEPTH", "Cstock")],
                       dataC[, c("N_PLOT","ID_AF", "ID_VILLAGE",  "meanAGC")], by = "N_PLOT")

ggplot(data_soil_agc, aes(x = meanAGC, y = Cstock, col = SAMPLE_DEPTH)) +
  geom_point() +
  geom_smooth(method = "lm")

lm(data = data_soil_agc, Cstock ~ meanAGC * SAMPLE_DEPTH) |> summary()
lm(data = data_soil_agc[SAMPLE_DEPTH == "0-10"], Cstock ~ meanAGC) |> summary()
lm(data = data_soil_agc[SAMPLE_DEPTH == "10-20"], Cstock ~ meanAGC ) |> summary()
lm(data = data_soil_agc[SAMPLE_DEPTH == "20-30"], Cstock ~ meanAGC ) |> summary()
```

```{r compare-lit-values}
litval <- read_excel("data/literature-values.xlsx")
colnames(litval) <- c("system", "pool", "value", "location", "ref")


litval$main_crop <- NA
litval$main_crop[grepl("palm", litval$system)] <- "oil palm"
litval$main_crop[grepl("offee", litval$system)] <- "coffee"
unique(litval$system[is.na(litval$main_crop)])

litval$main_per <- NA
litval$main_per[grepl("nset", litval$system)] <- "enset"
litval$main_per[grepl("Inga", litval$system)] <- "inga"
litval$main_per[grepl("Eucalyptus", litval$system)] <- "eucalyptus"
litval$main_per[grepl("Pinus", litval$system)] <- "pinus"
unique(litval$system[is.na(litval$main_per)])

litval$ID_AF <- NA
litval$ID_AF[grepl("orests|orest |orest$", litval$system)] <- "forest"
litval$ID_AF[grepl("onoculture", litval$system)] <- "monoculture"
litval$ID_AF[!is.na(litval$main_crop) & !is.na(litval$main_per)] <- "two-crops"
litval$ID_AF[grepl("ome garden", litval$system)] <- "HG"
unique(litval$system[is.na(litval$ID_AF)])

litval$var <- as.numeric(gsub(" ", "", tstrsplit(litval$value, "±")[[2]]))
litval$value <- gsub(" ", "", tstrsplit(litval$value, "±")[[1]])

mult_values <- which(sapply(strsplit(litval$value, ",|and"), length)>1)

new_rows = lapply(mult_values, function(i){
  vals = as.numeric(strsplit(litval$value[i], ",|and")[[1]])
  vals = vals[!is.na(vals)]

  x = matrix(litval[i,], ncol = ncol(litval), nrow = length(vals), byrow = TRUE)
  x[, colnames(litval) == "value"] = vals

  x = as.data.frame(x)
  colnames(x) = colnames(litval)
  return(x)
}
)

new_rows = do.call(rbind, new_rows)

litval2 = rbind(new_rows, litval[-mult_values,])
litval = data.frame(system = unlist(litval2$system),
                    pool = unlist(litval2$pool),
                    value = unlist(litval2$value),
                    location = unlist(litval2$location),
                    ref = unlist(litval2$ref),
                    main_crop = unlist(litval2$main_crop),
                    main_per = unlist(litval2$main_per),
                    ID_AF = unlist(litval2$ID_AF),
                    var = unlist(litval2$var))

```

### Effect of altitude on SOC stocks

```{r sfig-altitude}
dataCelev = merge(dataC[, c("N_PLOT", "meanSOC", "uprSOC", "lwrSOC")], 
                 data_plot[, c("N_PLOT", "elev", "village")], by = "N_PLOT")

lmerTest::lmer(log(meanSOC) ~ log(elev) + (1|village), data = dataCelev) |> 
  summary()

ggplot(dataCelev, aes(x = elev, y = meanSOC, col = village)) +
  geom_pointrange(aes(ymin=lwrSOC, ymax = uprSOC)) + 
  theme_classic() +
  labs(x = "Elevation (m)", y = "SOC stocks (Mg C/ha)", col = "Site")
ggsave("figures/soc-elev.png", height = 4, width = 6)
```

### Site soil characteristics

```{r stab-site-soil}
data_soil$silt <- as.numeric(data_soil$`FINE SILT`) + as.numeric(data_soil$`COARSE SILT`)
data_soil$sand <- as.numeric(data_soil$`FINE SAND`) + as.numeric(data_soil$`COARSE SAND`)

vars = c("Corg\n", "N", "Corg_N", "CLAY", "silt", "sand", "pH\n", "CA", "Mg", "K", "Na", "CEC")
data_soil_plot = melt(data_soil, id.vars = c("village", "N_PLOT", "SAMPLE_DEPTH"), 
                      measure.vars = c("Corg\n", "N", "Corg_N", "CLAY", "silt", "sand", "pH\n", "Ca", "Mg\n", "K", "Na", "CEC\n"))

data_soil_plot[, variable := gsub("\n", "", variable)]

# when value below detection limit: use half of detection value
data_soil_plot[grepl("LD", value), value := as.numeric(strsplit(value, "=")[[1]][2])/2]
data_soil_plot[, value := as.numeric(value)]

# remove NA values
data_soil_plot = subset(data_soil_plot, !is.na(value))

# simulation 100 values per plot, soil depth and variable with a 12% coefficient
# of variation (CV value from lab)
data_soil_plot_simu = 
  data_soil_plot[, .(
    value = rnorm(100, value, sd = 0.12*value), n = 1:100), 
    .(village, N_PLOT, SAMPLE_DEPTH, variable)]

# bootstrap plot values to get mean value at the site level (for each simulation)
data_soil_site_simu = 
  data_soil_plot_simu[, .(
    value = mean(sample(value, length(value), replace = TRUE))),
    .(village, variable, n)]

# calculate mean and 95% confidence interval at site level
data_soil_site  = data_soil_site_simu[, .(
  value = paste0(
  signif(mean(value), 3), " (",
  signif(quantile(value, 0.025), 3), "-", 
  signif(quantile(value, 0.975), 3), ")"
  )), 
  .(village, variable)]

# change table shape to have one column per variable
data_soil_site = dcast(data_soil_site, village ~ variable, value.var = "value")
data_soil_site = data_soil_site[, c("village", "CLAY", "silt", "sand", "Corg", "N", "Corg_N", "pH", "Ca", "K", "Mg", "Na", "CEC")]
colnames(data_soil_site) = c("Site", "Clay (%)", "Silt (%)", "Sand (%)", "SOC content (%)","N", "C/N", "pH", "Ca", "K", "Mg", "Na", "CEC")

write.csv(data_soil_site, "data/soil_site.csv", row.names = FALSE)
```

### Botanical identification from Tetum names

```{r tab-tetum-names}
sheets1 = grep("INV", readxl::excel_sheets("data/DATA_BIOMASS_TL_LARGE.xlsx"), value = TRUE)
sheets2 = grep("INV", readxl::excel_sheets("data/DATA_BIOMASS_TL_SHORT.xlsx"), value = TRUE)

vern1 <- lapply(sheets1, \(x){
  df = readxl::read_excel("data/DATA_BIOMASS_TL_LARGE.xlsx", sheet = x)
  df = df[, c("TETUM_NAME", "SCIENTIFIC_NAME")] |>
    unique() |>  subset(!SCIENTIFIC_NAME %in% c("Unknown", "NR", "Unkown"))
})
vern2 <- lapply(sheets2, \(x){
    df = readxl::read_excel("data/DATA_BIOMASS_TL_LARGE.xlsx", sheet = x)
  df = df[, c("TETUM_NAME", "SCIENTIFIC_NAME")] |>
    unique() |>  subset(!SCIENTIFIC_NAME %in% c("Unknown", "NR", "Unkown"))
})

vern = rbind(rbindlist(vern1), rbindlist(vern2)) |>  unique()
vern <- subset(vern, !is.na(TETUM_NAME) & !is.na(SCIENTIFIC_NAME))

## correct scientific names
vern[, c("genus", "species") := tstrsplit(SCIENTIFIC_NAME, " ")[1:2]]
vern[species %in% c("sp", "sp."), species := NA]
vern[species == "purpuroides", species := NA]
corr = BIOMASS::correctTaxo(genus = vern$genus, species = vern$species)
vern = cbind(vern, corr)

vern[, latin := paste(genusCorrected, speciesCorrected)]
vern[, latin := gsub(" NA", " sp.", latin)]
vern[,tetum := gsub("  ", " ", tolower(TETUM_NAME))]
vern <- vern[, c("tetum", "latin", "genusCorrected", "speciesCorrected")]
vern = unique(vern)

# check that all names are unique
# if one tetum name has two levels of id (same genus), keep better identification
dupl_tetum <- vern[duplicated(tetum), unique(tetum)]
vern = vern[!(tetum %in% dupl_tetum & is.na(speciesCorrected))]
setorder(vern, tetum)

vern = vern[, .(latin = paste(latin, collapse = ", ")), .(tetum)]
write.csv(vern, "data/species-correspondance.csv", row.names = FALSE)
```

```{r timer-leste-c-footprint-lulcc}
df_eluc <- read_excel("C:/Users/piponiot-laroche/Downloads/National_LandUseChange_Carbon_Emissions_2023v1.0.xlsx", sheet = "OSCAR") 
colnames(df_eluc) <- df_eluc[7,]
df_eluc <- df_eluc[-(1:8),colnames(df_eluc) %in% c("unit: Tg C/year", "Timor-Leste")]
```

# References
