---
title: "Traditional agroforestry systems in Timor-Leste can store large amounts of carbon in both soil and biomass"
author: "Camille Piponiot^*^, Marguerite Cogné^*^, Vincent Freycon, Alexis Thoumazeau, Marçal Gusmão, Régis Peltier"
date: ""
output: 
  officedown::rdocx_document:
    base_format: "bookdown::word_document2"
    reference_docx: word-styles-ref-02.docx
bibliography: references.bib
nocite: |
  @Orsini1976, @Nair1993, @Nair2021
csl: misc/springer-basic-author-date.csl
---

```{r setup, include=FALSE}
# Run with R version 4.3.2

packages_needed = c(
  "ggplot2",      # version 3.4.4
  "ggrepel",      # version 0.9.4
  "ggspatial",    # version 1.1.9
  "maps",         # version 3.4.2
  "ggpubr",       # version 0.6.0
  "readxl",       # version 1.4.3
  "data.table",   # version 1.14.8
  "knitr",        # version 1.45
  "BIOMASS",      # version 2.1.11
  "terra",        # version 1.7-55
  "car",          # version 3.1-2
  "lmerTest",     # version 3.1-3
  "lme4",         # version 1.1-35.1
  "Matrix",       # version 1.6
  "performance",  # version 0.10.8
  "flextable"     # version 0.9.5
)

packages_to_install = packages_needed[!( packages_needed %in% rownames(installed.packages()))]

if (length(packages_to_install) > 0)
  install.packages(packages_to_install)

lapply(packages_needed, require, character.only = TRUE)

opts_chunk$set(echo = FALSE, warning=FALSE, message=FALSE, results = "hide")
```

**Journal**: Agroforestry Systems

**Word count**: 8365; **Figure and table count**: 5 

# Abstract

Agroforestry has the potential to make agriculture more resilient while improving carbon sequestration by incorporating trees and other woody perennials into agricultural land and diversifying landscapes. Traditional agricultural systems in tropical areas often include trees, but their carbon sequestration potential is not always well described, hindering their inclusion in climate change mitigation strategies. In this study, we quantified carbon storage in both vegetation biomass and soil in five traditional agroforestry systems (AFS) in Timor-Leste, namely cropping systems with fallow, silvopastures, young agroforests, home gardens, and forest gardens. Our results show that these traditional AFS can store large amounts of carbon, with the average being 156\ Mg\ C\ ha$^{-1}$. The AFS with the highest carbon stocks (forest gardens) stored an average of 210\ Mg\ C\ ha$^{-1}$, close to the values of old-growth tropical forests. Biomass carbon was strongly dependent on the type of AFS (which differed in tree cover), while soil carbon was less variable between AFS but more dependent on site. We found no relationship between the amount of carbon stored in biomass and soil. Our results highlight the high diversity of traditional AFS in Timor-Leste and their high carbon sequestration capacity. These results could provide an important baseline for the inclusion of AFS in Timor-Leste’s climate change mitigation strategy, and could serve as a reference for future AFS studies in different agro-climates of Timor-Leste. 

# Introduction

Agricultural expansion has been the main driver of tropical deforestation over the past half century [@Pendrill2022;@Gibbs2010;@Rudel2009], resulting in large greenhouse gas emissions [approximately 2.6 gigatonnes CO~2~e/yr over 2010-2014; @Pendrill2019]. The demand for tropical agricultural land is expected to continue to grow as the world’s population increases [@UN2022]. In addition, tropical areas are expected to be disproportionately affected by climate change, putting their agriculture and food systems at risk [@Lawrence2015]. There is therefore an urgent need to promote tropical agricultural landscapes that are more resilient to climate change while maintaining high productivity and ecological value [@Harvey2014]. In particular, increasing the amount of carbon stored in the soil and vegetation of agricultural landscapes could be an effective way to mitigate climate change while increasing the resilience of food production systems [@Lal2004;@Minasny2017].

Agroforestry has attracted attention in recent decades as a set of effective agricultural practices that could contribute to climate change mitigation and adaptation [@Albrecht2003;@Verchot2007;@Lasco2014;@Cardinael2021]. Agroforestry is a collective name for land use systems and technologies where woody perennials (trees, shrubs, bamboos, creepers, etc.) are deliberately used on the same land management units as agricultural crops and/or animals, in some form of spatial arrangement or temporal sequence [@Lundgren1982]. Agroforestry allows for the diversification of agricultural production, making agricultural systems more resilient [@Duffy2021;@Terasaki2023]. 

Agroforestry systems (AFS) have the potential to store large amounts of carbon in the vegetation and soil, and this carbon storage capacity depends on the characteristics of the AFS considered [@Albrecht2003;@Feliciano2018]. As trees can store large amounts of carbon, the carbon stored in the vegetation of AFS is largely dependent on the number and size of trees in the system [@Ma2020]. However, the effect of AFS on soil organic carbon (SOC) has been relatively little studied [@Beillouin2021], is more variable and depends on several factors. Although AFS appear to increase SOC stocks overall, some AFS such as woodlots (i.e., planting trees with intercropping during the establishment phase) may decrease SOC stocks compared to non-AFS, while AFS such as silvopastures have been shown to strongly increase SOC stocks [@Feliciano2018]. Other factors such as climate and previous land use type can also influence SOC in AFS, which may explain the variability of observations reported in the literature [@Feliciano2018;@Ma2020;@Martin2020]. Furthermore, the relationship between the amount of carbon stored in aboveground vegetation and soil in AFS could only be evidenced for the topsoil layer [< 10 cm; @Ma2020]. 

In Timor-Leste, a large proportion of the population depends on agriculture for their livelihoods. However, population growth, increasing pressure on natural resources, and an increasingly variable climate with an unreliable rainfall regime are threatening food security [@WB2009;@Molyneux2012]. In this context, productive, resilient, and sustainable agriculture is critical for the country, and agroforestry has been presented as a potential solution to many of the challenges facing Timorese agriculture [@Paudel2022;@Cogne2024]. Although trees already form a large part of traditional agricultural systems in Timor-Leste [@Paudel2022;@Cogne2024] and can be key elements for biodiversity conservation [@Perfecto2008;@Torquebiau1992], they have received little attention and, to our knowledge, no study has quantified carbon storage in traditional Timorese AFS. A precise quantification of these carbon stocks would improve understanding of the ecological importance of these AFS at both local and global scales, and help integrate them into national and international climate change mitigation initiatives.

In this study, we aim to better understand traditional AFS in Timor-Leste by quantifying the carbon storage in both biomass and soil of five traditional AFS: cropping systems with fallow, silvopastures, young agroforests, home gardens, and forest gardens. We hypothesize that there are measurable differences in aboveground carbon (AGC; H1a) and SOC (H1b) stocks between these different types of traditional AFS. In line with Ma et al. (2020), we anticipate that there is a positive relationship between AGC and SOC stocks in the topsoil layer (0-10 cm; H2a), but no relationship with SOC below 10 cm (H2b).


# Materials and methods

```{r download-data}
## download data from dataverse - once published
# dataverse_url <- "https://dataverse.cirad.fr/privateurl.xhtml?token=f8eabb2a-3635-499b-aee5-80fd2b7495a0"
# 
# # for now : download manually from temporary link
# if (!dir.exists("data")) create.dir("data")
# unzip("data/dataverse_files.zip")
# 
# 
# library(dataverse)
# server<- "dataverse.cirad.fr"
# doi_dataset <- "doi:10.18167/DVN1/QCXWIY"
# # key<- "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
# 
# Sys.setenv(DATAVERSE_SERVER = server)
# # Sys.setenv(DATAVERSE_KEY = key)
# 
# # get the dataset
# ds1<-get_dataset(doi_dataset,version = ":latest")
# #lister les fichiers
# ds1$files$filename
# 
# #recupérer le fichier par le nom
# data <- get_dataframe_by_name("DATA_BIOMASS_TL_LARGE.xlsx", doi_dataset)
``` 

## Study area

```{r get-site-info}
## Load plot location data 
data_coord <- read_xlsx("data/DATA_BIOMASS_TL_LARGE.xlsx", sheet = "GPS")
setDT(data_coord)

# get plot number
data_coord[, N_PLOT := as.numeric(tstrsplit(N_Q_ID, "_")[[1]])]

# get coordinates
data_coord <- data_coord[, .(long = mean(as.numeric(LONG)), lat = mean(as.numeric(LAT))), .(N_PLOT)]

## Load plot general information
data_plot <- read_excel("data/DATA_BIOMASS_TL_SHORT.xlsx", "PLOT_GENERAL_INFO") |> 
  subset(N_PLOT != 8)  # remove plot 8: no soil data

# merge plot coordinates with general information (site, AFS)
data_plot <- merge(data_coord, data_plot[, c("N_PLOT", "ID_VILLAGE", "ID_AF", "AREA_TOTAL_PARCEL")])

# simplify site names
data_plot[, site := substr(ID_VILLAGE, 1, 1)]
data_plot[site == "S", site := "Osso-Luga"]
data_plot[site == "G", site := "Gariuai"]
```


```{r get-env-data}
# precipitation from CHELSA
if (!file.exists("data/CHELSA_bio12_1981-2010_V.2.1.tif")) {
  url <- "https://os.zhdk.cloud.switch.ch/envicloud/chelsa/chelsa_V2/GLOBAL/climatologies/1981-2010/bio/CHELSA_bio12_1981-2010_V.2.1.tif"
  destfile <- "data/CHELSA_bio12_1981-2010_V.2.1.tif"
  download.file(url, destfile, method = "curl")
  
  ## crop to reduce memory usage
  box = c(124.5, 127.5, -9.2, -8.3) # Timor-Leste
  rst <- terra::rast(destfile)
  rst <- terra::crop(rst, terra::ext(box))
  writeRaster(rst, filename = destfile, overwrite = TRUE) 
} 

# 30m resolution SRTM
if (!file.exists("data/CHELSA_bio12_1981-2010_V.2.1.tif")) {
  url <- "https://srtm.csi.cgiar.org/wp-content/uploads/files/srtm_5x5/TIFF/srtm_62_14.zip"
  destfile <- "data/srtm_62_14.zip"
  download.file(url, destfile, method = "curl")
  unzip(destfile, exdir = "data", overwrite = TRUE)
} 

# download cwd from Chave et al 2014
if (!file.exists("data/CWD.tif")) {
  url <- "http://chave.ups-tlse.fr/pantropical_allometry/CWD.tif.zip"
  destfile <- "data/CWD.tif.zip"
  download.file(url, destfile, method = "curl")
  unzip(destfile, exdir = "data", overwrite = TRUE)
}
```


```{r extract-env-data}
# extract elevation and rainfall for the 2 sites
site_env = data_plot[, as.list(expand.grid(seq(min(long), max(long), 0.001), 
                                           seq(min(lat), max(lat), 0.001))),
                     .(site)]

colnames(site_env) = c("site", "long", "lat")

# get precipitation data for the two sites
site_env[, prec := terra::extract(
  terra::rast("data/CHELSA_bio12_1981-2010_V.2.1.tif"), 
  cbind(long, lat)
)]

# get elevation data for the two sites
site_env[, elev := terra::extract(
  terra::rast("data/srtm_62_14.tif"), 
  cbind(long, lat)
)]

site_summary = site_env[, .(
  coord = paste(round(mean(long),2), round(mean(lat),2), sep = ", "), 
  prec = round(mean(prec)), 
  elev = paste(round(quantile(elev, c(0.025, 0.975))/10)*10, collapse = " and ")),
  .(site)]
```

The research was carried out in the center of the Baucau municipality, located on the north-eastern coast of Timor-Leste. Two communities, or *suco* (a group of villages), were selected to represent two contrasting topo-geographical, climatic and historical cases. The first, Gariuai *suco* (long-lat coordinates: `r site_summary[site=="Gariuai", coord]`), is located on a plateau of Baucau limestone, with an annual rainfall of `r site_summary[site=="Gariuai", prec]` mm and an altitude ranging between `r site_summary[site=="Gariuai", elev]` m above sea level (asl). The second, the village of Osso-Luga in Samalari *suco* (long-lat coordinates: `r site_summary[site=="Osso-Luga", coord]`), is located on the Matebian foothills based on Bobonaro Scaly Clay, with an annual rainfall of `r site_summary[site=="Osso-Luga", prec]` mm and an altitude ranging between `r site_summary[site=="Osso-Luga", elev]` m asl (Figure\ \@ref(fig:map-sites)). The soils of the Baucau municipality are classified using the WRB soil classification [@Mantel2023] as Lithosols and Calcic Luvisols [@FAO2012]. The average soil properties differ between the two sites (Table\ S\@ref(tab:site-soil)); Gariuai has a clay loam texture whereas Osso-Luga has a clay texture. The two villages also have different recent histories. Gariuai has been inhabited for at least 50 years, while Osso-Luga was abandoned during the Indonesian occupation and was only repopulated after Timor-Leste gained independence in 2002. The AFS in Osso-Luga lay fallow during the period of abandonment.

## Typology of agroforestry systems

We used the typology described in @Cogne2024, which was developed in the same study area. This typology was based on the one proposed by Nair et al. (1993, 2021) and adapted to the local context with semi-structured interviews conducted in the same study area [@Cogne2024]. The five AFS identified were as follows: Crop systems including a wooded Fallow phase (CF), Silvopastures (SP), Young Agroforests (YA), Home Gardens (HG), and Forest Gardens (FG). CF are plantations of a few non-perennial crops (such as maize, sweet potatoes, groundnuts, and squash) which are left fallow after one to three years. SP are vast areas (generally 200 to 500 ha) where cattle are grazed under the shade of trees. YA are agricultural plots where farmers plant rows of trees spaced approximately 5 x 10 m apart, which they maintain for two to ten years. HG are plots of land located close to houses where crops and livestock (poultry, pigs, cattle, etc.) are kept in the shade of numerous trees and palms for multiple uses (wood, fruit, fiber, etc.). FG are generally former HG (over 50 years old) which have been abandoned, for example as a result of the war, and are now used mainly for gathering with limited human influence.

The AFS are presented in more detail in the supplemental information section (Table\ S\@ref(tab:afs-typology)) and in @Cogne2024. 

## Field inventories

We randomly selected three plots from each of the five traditional AFS identified in each of the two sites (30 plots in total; Figure\ \@ref(fig:map-sites)). Sampling plots were defined as the entire agricultural plot (area between 0.06 and 1.25 ha) for all AFS except SP plots, which were generally much larger than 1 ha. In SP plots, a 1 ha sampling plot was delineated within the agricultural plot. Tree and soil measurements (described below) were carried out between June and August 2021. 

### Tree measurements

Within each sampling plot, all trees with a circumference at breast height (CBH) greater than or equal to 100 cm were identified taxonomically and their CBH and height were measured. Five subplots of 10x10 m (0.01 ha) were established at each corner and in the center of the sampling plot (Figure\ S\@ref(fig:design)). Within these subplots, all trees with a CBH between 30 and 100 cm were taxonomically identified and their CBH and height were measured. Height measurements were taken with a dendrometer. 

Taxonomic identification was carried out using Tetum  (a national official language) vernacular names, which were then linked to scientific names using the iNaturalist and Pl\@ntNet applications, Geoffrey Hull’s monograph [@Hull2006], the “Useful tropical plants” database [@Fern2014] as well as the Australian Northern Territory Government's Native Plants Herbarium [@NT2013]. The correspondence between Tetum names and scientific names is provided in the supplemental material (Table S\@ref(tab:tetum-names)). 

### Soil measurements

In each of the 30 sample plots, three composite samples were taken from three of the five 10 x 10 m subplots, following a transect covering the intra-plot variability and at a minimum distance of 1 m from any tree (Figure\ S\@ref(fig:design)). Soils were sampled with a 15 cm auger at 0-10 cm and 20-30 cm depth; due to the size of the auger we could not accurately sample the intermediate soil layer. Soils samples were then air-dried and sieved at 2 mm. They underwent standard physical and chemical analyses at Cirad laboratories in Montpellier, France (Table\ S\@ref(tab:site-soil)). Total organic carbon was determined by dry combustion and measured with a thermal conductive detector.

In addition, at one location at the center of the plot, soils were sampled with a cylinder of 250 cm3 at 2-7 cm, 12-17 cm and 22-27 cm. Each sample was dried at 105°C in a classic oven until a stable dry mass was reached and then sieved to 2 mm. The fine fraction (< 2 mm) was weighed to be used in the SOC stocks calculation (equation \@ref(eq:soc)). 

## Carbon stocks estimation

### Biomass estimation

```{r agc-estimation}
### 1. Open data 

# Open large tree data (> 100 cm circumference)
data_large <- read_excel("data/DATA_BIOMASS_TL_SHORT.xlsx", "TREE INV >100CM")

# Open small tree data (30-100 cm circumference)
data_small <- read_excel("data/DATA_BIOMASS_TL_SHORT.xlsx", "TREE INV 30-100CM")

### 2. Combine tables

# create a "N_Q_ID" column in data_large, with corresponding quadrat number =
# "TOT" (entire plot)
data_large$N_Q_ID <- paste(data_large$N_PLOT, "TOT", sep = "_")

# common columns to be kept
col_keep <- c("N_PLOT", "N_Q_ID", "SCIENTIFIC_NAME", "DIAM_130_CM", "HEIGHT")

# stack tree tables
data_tree <- rbind(data_large[, col_keep], data_small[, col_keep])

# merge with plot information
data_tree <- merge(data_tree, data_plot, by = "N_PLOT")

# convert data_tree into data.table 
setDT(data_tree)

### 3. Clean tables 

# remove NA or <30 cm circumference values or < 100 cm outside subplots
data_tree <- subset(data_tree, 
                    !is.na(DIAM_130_CM) & 
                      DIAM_130_CM >= 30/pi &
                      (DIAM_130_CM >= 100/pi | grepl("Q", N_Q_ID)))

# split scientific names into genus and species
names <- tstrsplit(data_tree$SCIENTIFIC_NAME, " ")

# get genera
data_tree$GENUS <- names[[1]]

# get species
data_tree$SPECIES <- names[[2]]

# Timoneus should be Timonius
data_tree$GENUS[!is.na(data_tree$GENUS) & data_tree$GENUS == "Timoneus"] <- "Timonius"

# remove one tree with DBH = 0
data_tree <- subset(data_tree, DIAM_130_CM > 0)

### 4. Get values for Chave et al., 2014 equation

# get wood density
data_wd <- getWoodDensity(genus = data_tree$GENUS, species = data_tree$SPECIES) 

# estimate mean AGC
data_tree$mean <- computeAGB(
  D = data_tree$DIAM_130_CM, 
  WD = data_wd$meanWD, 
  H = data_tree$HEIGHT
) * 0.4713 # conversion factor from biomass to carbon 


### estimate AGC with uncertainty propagation

# 15% coefficient of variation on height
cvH <- 0.15

data_sim_agc <- data.table(
  data_tree,
  AGBmonteCarlo(
    D = data_tree$DIAM_130_CM, 
    WD = data_wd$meanWD, 
    errWD = data_wd$sdWD, 
    H = data_tree$HEIGHT, 
    errH = data_tree$HEIGHT*cvH, 
    Dpropag = "chave2004", 
    n = 1000,
    Carbon = TRUE
  )$AGC_simu
) |> 
  melt(
    measure.vars = c("mean", paste0("V", 1:1000)),
    variable.name = "iter",
    value.name =  "AGC"
  )

### 5. Apply a different allometry for palms
palm_genera <- c("Cocos", "Areca", "Arenga", "Corypha", "Borassus")

## height in cm, with a conversion factor between 0.8 and 1
data_sim_agc[GENUS %in% palm_genera, 
             HEIGHT := ifelse(
               iter == "mean", 
               HEIGHT*.9* 100,  ## height in cm
               rnorm(length(HEIGHT), HEIGHT, HEIGHT*cvH)*
                 runif(length(HEIGHT), .8, 1)* 100
             )]

## add WD data
data_wd_palms = unique(data_wd[data_wd$genus %in% palm_genera, c("genus", "meanWD", "sdWD")])
data_sim_agc = merge(
  data_sim_agc,
  data_wd_palms,
  all.x = TRUE,
  by.x = "GENUS",
  by.y = "genus"
)
data_sim_agc[GENUS %in% palm_genera, 
             WD := ifelse(iter == "mean", 
                          meanWD, 
                          rnorm(length(meanWD), meanWD,sdWD))]

data_sim_agc[GENUS %in% palm_genera, 
             AGC := WD * HEIGHT * (DIAM_130_CM/2)^2 * pi * 
               0.89 * # volumetric shrinkage
               1e-6 * # convert from g to tons
               0.4713 # conversion factor from biomass to carbon
]
```

We estimated tree-level AGC stocks from the tree CBH and height measurements using the pantropical allometric equation from @Chave2014 and the R package BIOMASS [@Rejou-Mechain2017]. Each tree was assigned a mean and standard deviation of wood density at the species or genus level when at least one value was available from the Global Wood Density Database [@Zanne2009]. Other taxa were assigned a plot-level average wood density. The biomass of the palms was estimated by multiplying their estimated volume by their estimated wood density. The volume of the palm trunks was estimated as a cylinder, using the height and diameter measured *in situ*, with a volumetric shrinkage of 11% [@WD2007]. The height of the palms was measured above the leaves and was therefore multiplied by a conversion factor of 0.9 to obtain the trunk height. Biomass was then converted into carbon with a factor of 0.4713 [@Thomas2012].

Belowground carbon (BGC) stocks were estimated at tree level using the root-to-shoot ratio equation from @Ledo2018, which is based on tree DBH and climatic water deficit from @Chave2014. This ratio was then multiplied by the estimated AGC stock to obtain tree-by-tree BGC stock. 

```{r bgc-estimation}
# root-to-shoot ratio allometry from Ledo et al., 2018
# use CWD values from Chave et al., 2014
data_plot[, cwd := terra::extract(terra::rast("data/CWD.tif"), cbind(long, lat))]
data_sim_agc <- merge(data_sim_agc, data_plot[, c("N_PLOT", "cwd")], by = "N_PLOT")

# add uncertainty on R:S ratio? 
data_sim_agc[, RS := exp(- 1.2312 - 0.0215 * DIAM_130_CM + 0.0002 * DIAM_130_CM^2 - 0.0007 * cwd)]
data_sim_agc[, BGC := RS * AGC]
```

Plot-level AGC and BGC stocks were then obtained by summing tree-level stocks and dividing by the plot area.

```{r aggregate-biomass-data}
# replace with area = 0.05 for quadrats (5 quadrats of 0.01 ha each)
data_sim_agc[, area := ifelse(grepl("Q", N_Q_ID), 0.01, AREA_TOTAL_PARCEL)]

# melt data frame
data_sim <-
  melt(
    data_sim_agc,
    id.vars = c("N_PLOT", "N_Q_ID", "ID_VILLAGE", "ID_AF", "iter", "area"),
    measure.vars = c("AGC", "BGC")
  )

# estimate biomass per quadrat and plot
data_sim <-
  data_sim[, .(value = sum(value / area)), .(N_PLOT, N_Q_ID, ID_VILLAGE, ID_AF, iter, variable)]

## bootstrap AGC and BGC values in small plots (except for iter = mean)
data_sim = 
  merge(
    data_sim[!grepl("Q", N_Q_ID)], 
    rbind(
      data_sim[grepl("Q", N_Q_ID) & iter != "mean", .(
        valueSmall = ifelse(
          length(value) == 0,   ## some quadrats have zero trees: complete their values
          0, 
          mean(sample(c(value, rep(0, 5 - length(value))), replace = TRUE))
        )), .(N_PLOT, variable, iter)], 
      data_sim[grepl("Q", N_Q_ID) & iter == "mean", 
               .(valueSmall = sum(value / 5)), .(N_PLOT, variable, iter)]
    ),
    by = c("N_PLOT", "variable", "iter"), all = TRUE
  )

# replace NAs is valueSmall (ie no trees in quadrats) with 0
data_sim[, valueSmall := ifelse(is.na(valueSmall), 0, valueSmall)]

## sum mean biomass in quadrats and entire plot
data_sim[, value := value + valueSmall]

## add zeros for plots with no tree above 10 cm DBH
# deal with non detectable values: https://www.ncbi.nlm.nih.gov/pmc/articles/PMC9216349/
# use uniform distribution between zero and limit of detectability
data_sim_empty = expand.grid(N_PLOT = setdiff(data_plot$N_PLOT, data_sim$N_PLOT), 
                             iter = unique(data_sim$iter), 
                             variable = c("AGC", "BGC"))|> 
  setDT() |> merge(data_plot[, c("N_PLOT", "ID_VILLAGE", "ID_AF")]) 
data_sim_empty$value = 0

# limit of detectability: tree of 30 cm CBH, mean WD and height (for this DBH)
# LOD = computeAGB(D = 30/pi, 
#                  WD = unique(data_wd$meanWD[data_wd$genus=="NR"]), 
#                  H = data_tree[DIAM_130_CM == 30/pi, mean(HEIGHT)])
# data_sim_empty[iter != "mean", AGC := runif(sum(iter != "mean"), 0, LOD)]
# data_sim_empty[iter == "mean", AGC := LOD/2]
# RS = mean(data_sim_agc$RS[data_sim_agc$DIAM_130_CM==30/pi])
# data_sim_empty[, BGC := AGC * RS]

# data_sim_empty = melt(data_sim_empty, measure.vars = c("AGC", "BGC"))

data_sim = rbind(data_sim[, colnames(data_sim_empty), with = FALSE], data_sim_empty)
```

### Soil organic carbon estimation

Soil organic carbon stocks (in Mg\ C\ ha$^{-1}$) were then calculated as follows: 

\begin{equation}
SOC_i = \frac{\sum_i Corg_i \cdot (mfine_i \cdot 10^{-6}) \cdot (Splot \cdot \Delta d)}{Vcyl} (\#eq:soc)
\end{equation}


Where $Corg_i$ is the organic carbon content at depth $i$ (either 0-10, 10-20 or 20-30 cm); $mfine_i$ is the mass of the fine fraction of the soil in the sampling cylinder at depth $i$ (in g), converted into Mg with a factor of 10$^{-6}$; $Splot$ is the surface of a 1-ha plot (10$^8$ cm$^2$); $\Delta d$ is the difference in sample depths (= 10 cm) and $Vcyl$ is the volume of the sampling cylinder (250 cm$^3$). This calculation corresponds to the method recommended by @Poeplau2017 (M4), which correctly takes into account the coarse fraction of the soil. At depth $i$ = 10-20 cm, where the carbon content was not measured (see "Soil measurements" section), we used the average of the carbon content values at 0-10 and 20-30 cm.  

```{r open-soil-data}
# open soil lab data
data_soil_lab <- read_excel("data/RESUME_DATA_SOIL_SHORT_TL.xls", sheet = "RESUME-LAB ")

# open soil field measurements
data_soil_field <- read_excel("data/RAW_DATA_SOIL_LARGE_TL.xls", sheet = "SAMPLING_MEASURE")

# change format of depth to correspond to other soil table
data_soil_field$SAMPLE_DEPTH <- factor(data_soil_field$DEPTH_SAMPLE_C, levels = c("2_7", "12_17", "22_27"))
levels(data_soil_field$SAMPLE_DEPTH) <- c("0-10", "10-20", "20-30")

data_soil <- merge(data_soil_lab, data_soil_field, by = c("N_PLOT", "SAMPLE_DEPTH"), all=TRUE)
setDT(data_soil)
```

```{r add-missing-values}
## add intermediate soil carbon in 10-20 cm depth
data_soil[, Corg := `Corg\n`]
data_soil[, muCorg := mean(Corg, na.rm = TRUE), .(N_PLOT)]
data_soil[is.na(Corg), Corg := muCorg]
```

```{r soc-error-propagation}
data_soil[, c("h0", "h1") := lapply(tstrsplit(SAMPLE_DEPTH, "-"), as.numeric)]

## error propagation using a Monte Carlo method -------------
data_sim_soil = data_soil[, .(mfine = c(Sample_DRY, rnorm(1000, Sample_DRY, Sample_DRY*0.1)), # 10% error on fine soil mass
                              Corg = c(Corg, rnorm(1000, Corg, Corg*0.12)), # 12% error on C content measurement
                              iter = c("mean", paste0("V", 1:1000))), 
                          .(N_PLOT, SAMPLE_DEPTH, h1, h0)]

data_sim_soil[, Cstock :=             ## in Mg/ha
                (h1 - h0) * 1e8 *     ## equivalent volume of a 1 ha soil sample, in cm3/ha
                Corg/100 *            ## carbon organic content in fine soil (unitless)
                (mfine * 1e-6) * ## mass of the fine fraction of the soil (Mg)
                (1/250)        ## 1/volume of the cylinder, in cm-3
]

# sum over depths + at 0-10 cm depth
data_sim_soil = data_sim_soil[, .(
  SOC = sum(Cstock), 
  SOC10 = Cstock[SAMPLE_DEPTH == "0-10"]),
  .(N_PLOT, iter)
]

## melt data 
data_sim_soil = melt(data_sim_soil, id.vars = c("N_PLOT", "iter"))
```

```{r merge-all}
## merge with biomass data
data_sim = rbind(data_sim[, colnames(data_sim_soil), with = FALSE], data_sim_soil) |> 
  merge(data_plot[, c("N_PLOT", "site", "ID_AF")], by = "N_PLOT")

# add total carbon stocks
data_sim = rbind(data_sim, data_sim[, .(value = sum(value[variable != "SOC10"]), variable = "TOT"), .(N_PLOT, site, ID_AF, iter)])
```


## Statistical analysis

All statistical analyses were carried out using the R software [@R2023].

### Statistical tests

The estimated AGC and SOC stocks were log-transformed for all statistical tests because, as they only take positive values, we expected them to be log-normally distributed. We removed one CF plot at Gariuai from the following statistical tests, as it did not contain any trees exceeding the minimum measurement size (CBH = 30 cm) and its AGC stocks were therefore estimated at 0\ Mg\ C\ ha$^{-1}$ (even if there were trees < 30 cm CBH) and could not be log-transformed. After testing for normality (Shapiro-Wilks test) and homoscedasticity (Levene’s test), we performed a two-way ANOVA on the log-transformed estimates of AGC and SOC stocks, grouped by AFS and site. To test the relationship between log-transformed SOC and AGC stocks, we fitted two linear mixed models. We predicted SOC stocks at two different depths (either 0-10 or 0-30 cm) as a function of AGC stocks (fixed effect) and site (Samalari or Osso-Luga; random effect).

### Uncertainty propagation

The uncertainty on plot-level AGC was calculated with the AGBmonteCarlo function from the R package BIOMASS, using a (rather conservative) coefficient of variation of 15% on height measurements [@Hunter2013] and large and small errors for 5 and 95% of trees, respectively [@Chave2004;@Rejou-Mechain2017]. To propagate uncertainty on SOC estimates, we used a coefficient of variation of 12% for organic carbon (as recommended by Cirad laboratories in Montpellier, France), and 10% for the mass of the fine fraction [@Page1999].

We then propagated these uncertainties using a Monte Carlo method (1000 iterations). For single plot estimates of carbon stocks, medians and 95% confidence intervals were estimated as quantiles of the results of the 1000 iterations. For multiplot estimates of carbon stocks, values within each grouping factor were additionally bootstrapped before calculating quantiles (median and 95% confidence intervals). 

```{r boot-results}
# plot level statistics
dataC_plot = data_sim[, .(
  mean = value[iter=="mean"],
  lwr = quantile(value, 0.025),
  upr= quantile(value, 0.975)
), .(plot = N_PLOT, site, afs = ID_AF, variable)]

# AFS level statistics (with bootstrapping)
dataC_afs = data_sim[, .(
  mean = mean(value),
  meanBs = mean(sample(value, replace = TRUE))
), .(afs = ID_AF, variable, iter)][, .(
  mean = mean[iter=="mean"],        
  lwr_mean = quantile(meanBs, 0.025),   
  upr_mean = quantile(meanBs, 0.975)
), .(afs, variable)]

# site level statistics (with bootstrapping)
dataC_site = data_sim[, .(
  mean = mean(value),
  meanBs = mean(sample(value, replace = TRUE))
), .(site, variable, iter)][, .(
  mean = mean[iter=="mean"],    
  lwr_mean = quantile(meanBs, 0.025),   
  upr_mean = quantile(meanBs, 0.975)
), .(site, variable)]

# AFS + site level statistics (with bootstrapping)
dataC_afs_site = data_sim[, .(
  mean = mean(value),
  meanBs = mean(sample(value, replace = TRUE))
), .(afs = ID_AF, site, variable, iter)][, .(
  mean = mean[iter=="mean"],        
  lwr_mean = quantile(meanBs, 0.025),   
  upr_mean = quantile(meanBs, 0.975)
), .(afs, site, variable)]
```

```{r group-comparison}
# shapiro wilk test - normality
dataC_plot[variable %in% c("AGC", "SOC") & plot != 6, .(
  shap = shapiro.test(log(mean))$p.value
), .(afs, variable)]
# levene test of homoscedasticity
dataC_plot[variable %in% c("AGC", "SOC") & plot != 6, 
           leveneTest(log(mean) ~ afs*site)$`Pr(>F)`[1], .(variable)]

# 2-way anova 
anova_table = 
  dataC_plot[variable %in% c("AGC", "SOC") & plot != 6, 
             .(pvalue = round(anova(lm(log(mean) ~ site + afs))$`Pr(>F)`[1:2], 3)), 
             .(variable)]
anova_table$factor = rep(c("site", "afs"), 2)
```

```{r lmereg}
data_reg = melt(dataC_plot[plot != 6], measure.vars = c("mean", "lwr", "upr"), variable.name = "stat") |> 
  dcast(plot + site+ afs ~ variable + stat)

## mixed effect linear regression
lmeReg <- lmer(log(SOC_mean) ~ log(AGC_mean) + (1|site), data = data_reg)
# Nakagawa’s R2 for mixed models
R2 = r2_nakagawa(lmeReg)
summary(lmeReg)

# same for topsoil layer (0-10 cm)
lmeReg10 <- lmer(log(SOC10_mean) ~ log(AGC_mean) + (1|site), data = data_reg)
# Nakagawa’s R2 for mixed models
R210 = r2_nakagawa(lmeReg10)
summary(lmeReg10)

dfreg = 
  data.table(
    depth = c("Soil depth: 0-30 cm", "Soil depth: 0-10 cm"), 
    intercept = c(summary(lmeReg)$coefficients[1,1], summary(lmeReg10)$coefficients[1,1]), 
    slope = c(summary(lmeReg)$coefficients[2,1], summary(lmeReg10)$coefficients[2,1]), 
    pvalue = c(summary(lmeReg)$coefficients[2,5], summary(lmeReg10)$coefficients[2,5]),
    R2_cond = c(R2$R2_conditional, R210$R2_conditional), 
    R2_marg = c(R2$R2_marginal, R210$R2_marginal)
  )
```

# Results

## Total carbon stocks

Total carbon stocks ranged between `r dataC_plot[variable=="TOT", round(min(mean))]` and `r dataC_plot[variable=="TOT", round(max(mean))]`\ Mg\ C\ ha$^{-1}$, with an average of `r dataC_plot[variable=="TOT", round(mean(mean))]`\ Mg\ C\ ha$^{-1}$ and a coefficient of variation of `r dataC_plot[variable=="TOT", round(sd(mean)/mean(mean)*100)]`%  (Table\ \@ref(tab:summary); Figure\ \@ref(fig:barplot)). The AFS with the lowest total carbon stocks were the `r dataC_afs[variable=="TOT", afs[which.min(mean)]]` with an average of `r dataC_afs[variable=="TOT", round(mean[which.min(mean)])]`\ Mg\ C\ ha$^{-1}$; the AFS with the highest total carbon stocks were the `r dataC_afs[variable=="TOT", afs[which.max(mean)]]` with an average of `r dataC_afs[variable=="TOT", round(mean[which.max(mean)])]`\ Mg\ C\ ha$^{-1}$ (Table\ \@ref(tab:summary); Figure\ \@ref(fig:barplot)).

## Aboveground carbon

AGC stocks ranged between `r dataC_plot[variable=="AGC", round(min(mean))]` and `r dataC_plot[variable=="AGC", round(max(mean))]`\ Mg\ C\ ha$^{-1}$, with an average of `r dataC_plot[variable=="AGC", round(mean(mean))]`\ Mg\ C\ ha$^{-1}$ and a coefficient of variation of `r dataC_plot[variable=="AGC", round(sd(mean)/mean(mean)*100)]`%  (Table\ \@ref(tab:summary); Figure\ \@ref(fig:barplot)). AGC stocks varied significantly between AFS (ANOVA p-value: `r subset(anova_table, variable=="AGC" & factor == "afs")$pvalue`, Table\ \@ref(tab:anova)), but not between sites (ANOVA p-value = `r subset(anova_table, variable=="AGC" & factor == "site")$pvalue`, Table\ \@ref(tab:anova)). The AFS with the lowest AGC stocks were the `r dataC_afs[variable=="AGC", afs[which.min(mean)]]` with an average of `r dataC_afs[variable=="AGC", round(mean[which.min(mean)])]`\ Mg\ C\ ha$^{-1}$; the AFS with the highest AGC stocks were the `r dataC_afs[variable=="AGC", afs[which.max(mean)]]` with an average of `r dataC_afs[variable=="AGC", round(mean[which.max(mean)])]`\ Mg\ C\ ha$^{-1}$ (Table\ \@ref(tab:summary); Figure\ \@ref(fig:barplot)).

## Soil organic carbon

SOC stocks varied between `r dataC_plot[variable=="SOC", round(min(mean))]` and `r dataC_plot[variable=="SOC", round(max(mean))]`\ Mg\ C\ ha$^{-1}$, with an average of `r dataC_plot[variable=="SOC", round(mean(mean))]`\ Mg\ C\ ha$^{-1}$ and a coefficient of variation of `r dataC_plot[variable=="SOC", round(sd(mean)/mean(mean)*100)]`%  (Table\ \@ref(tab:summary); Figure\ \@ref(fig:barplot)). No significant differences in SOC were observed between the five AFS studied (ANOVA p-value: `r subset(anova_table, variable=="SOC" & factor == "afs")$pvalue`, Table\ \@ref(tab:anova)). However, the measured SOC stocks differed between sites (ANOVA p-value: `r subset(anova_table, variable=="SOC" & factor == "site")$pvalue`, Table\ \@ref(tab:anova)). The SOC stocks in Gariuai were on average higher (`r dataC_site[site=="Gariuai" & variable=="SOC", round(mean)]`\ Mg\ C\ ha$^{-1}$) than those in Osso-Luga (`r dataC_site[site=="Osso-Luga" & variable=="SOC", round(mean)]`\ Mg\ C\ ha$^{-1}$; Figure\ \@ref(fig:barplot)).

## Relationship between AGC and SOC

The relationship between AGC and SOC was not significant (p-value = `r round(dfreg$pvalue[grepl("30", dfreg$depth)], 2)`; Figure\ \@ref(fig:plot-lmereg)). This relationship remained insignificant (p-value = `r round(dfreg$pvalue[grepl("10", dfreg$depth)], 2)`) when tested with SOC stocks in the topsoil layer (0-10 cm). The conditional R^2^ (i.e., the proportion of variance explained by the linear mixed models) were `r round(dfreg$R2_cond[grepl("30", dfreg$depth)]*100)`% and `r round(dfreg$R2_cond[grepl("10", dfreg$depth)]*100)`% for 0-30 and 0-10 cm depths, respectively, but the marginal R^2^ (i.e., when considering only the fixed effect) were only `r round(dfreg$R2_marg[grepl("30", dfreg$depth)]*100, 1)`% and `r round(dfreg$R2_marg[grepl("10", dfreg$depth)]*100, 1)`%, respectively (Figure\ \@ref(fig:plot-lmereg)).

# Discussion 

## Traditional AFS in Timor-Leste can store large C stocks

Compared to values reported in the literature for other AFS, the carbon stocks in this study were relatively high. Specifically, the average SOC stocks (`r dataC_plot[variable=="SOC", round(mean(mean))]`\ Mg\ C\ ha$^{-1}$) were higher than other reported values. In a meta-analysis by @Shi2018, it was estimated that AFS stored around 50\ Mg\ C\ ha$^{-1}$ at a 0-30 cm depth. Such large SOC stocks could be due to the high soil pH associated with high exchangeable Ca content at our sites (Table\ \@ref(tab:site-soil)), as Ca is frequently attributed to enhanced organic matter stabilization [@Wiesmeier2019]. In contrast, the average biomass stocks (`r dataC_plot[variable%in%c("AGC", "BGC"), sum(mean), .(plot)][, round(mean(V1))]`\ Mg\ C\ ha$^{-1}$) were similar to the average of 74\ Mg\ C\ ha$^{-1}$ estimated by @Ma2020, although some AFS had particularly high biomass values. The AFS with the highest carbon stocks, `r dataC_afs[variable=="TOT", afs[which.max(mean)]]`, had total carbon stocks (`r dataC_afs[variable=="TOT", round(max(mean))]`\ Mg\ C\ ha$^{-1}$) close to those of old-growth tropical forests [270\ Mg\ C\ ha$^{-1}$, @Lal2005]. The high carbon stocks in FG can be attributed to the length of time they had been established, which was generally longer than 50 years, with little human intervention (Table\ S\@ref(tab:afs-typology)). In terms of structure and carbon stocks, FG should therefore resemble old secondary forests, which have been shown to recover more than 60% of the AGC stocks and almost all the SOC stocks of an old forest [@Poorter2021]. In addition, FG contain a large number of trees of the same age that were planted when the AFS was established and can survive to reach significant sizes, similar to forest plantations that can grow to old-growth-forest levels of AGC stocks after only a few decades [@Brown2020;@Njoukam1996].

Although agroforestry has been identified as one of the possible levers to increase carbon storage in the Timorese agricultural landscape [@UNFCCC2020;@Paudel2022], to our knowledge no study has quantified carbon stocks in these systems. Our study could therefore help to better quantify the national contribution of agroforestry to Timor-Leste's climate change mitigation commitments [@UNFCCC2020] and the potential carbon gains from a wider adoption of these techniques. Further studies should help to increase the representativeness of the AFS sampled by including a greater diversity of AFS and environmental conditions. Another critical aspect is the quantification of temporal changes in carbon stocks, which could be assessed in future studies either by monitoring chronosequences of plots where the time since installation is known, or by remeasuring plots over time. 

## AFS differ in C stored in their biomass 

The AFS studied were found to differ significantly in terms of AGC stocks, in agreement with our hypothesis H1a. This result reflects the density and size of trees in the plot, which in turn depend on the importance of trees in the production system. In some systems, such as CF and SP, trees do not contribute directly to food production but have other functions, such as restoring soil fertility (e.g., during the fallow period) or providing shade for livestock. This more limited role for trees may explain why their total biomass is lower in these systems. In CF systems, the plot is periodically cleared and the remaining trees are pruned to allow the planted annual crops to receive full sun, while in SP systems, the growth of grazing grasses is favored by reducing the number of trees.

It is also interesting to note that, in line with previous results, the age of the trees in the AFS largely explains the carbon stored in their biomass [@Ma2020]. The AFS described in this study reflect different stages of transition in land use, which follow the growth of their trees (Figure\ S\@ref(fig:seq-diagram)). For example, a farmer might plant trees in a CF field, which will then become a YA that can still produce annual crops for the first 2 to 4 years, before the shade from the trees becomes too great. The trees are then used as property markers and, as they mature, produce wood and fruits; the YA then becomes an HG or FG. Similarly, our results show that AGC stocks increase from CF to YA, HG and FG (Table\ \@ref(tab:summary)).

The location of AFS in the landscape is not random, and could also explain the observed differences in AGC stocks. For example, most HG are located close to houses, in alluvial valleys that are well supplied with water and where soils are enriched with organic waste and animal manure [@Palm2001]. The same applies to FG, which are former HG that have been more or less abandoned, and YA, where the farmer has chosen the site with the intention of turning it into a HG. We therefore expect HG, FG and YA to be located in areas that are more favorable for tree growth [@Wagner2012;@Madejon2016;@Treuer2018]. Conversely, CF and SP are mainly located on limestone plateaus where water tables are deeper and soils are shallower, which could reduce tree growth and biomass [@Imada2008].

## Historical and environmental factors explain differences in SOC stocks

We found no significant difference in SOC between the AFS (H1b rejected). This result is inconsistent with our expectation that agroforestry practices affect SOC stocks [@Minasny2017;@Wiesmeier2019], and with previous studies that show significant differences in SOC stocks between AFS [e.g., @Ramesh2015]. However, it is worth noting that some single-site studies [e.g., @Betemariyam2020;@GamaRodrigues2010] and at least two meta-analyses failed to find any sizable effect of AFS on SOC stocks. @Feliciano2018 highlighted that only 3.2% of the variance in soil carbon sequestration was explained by the type of AFS, and @Shi2018 found no significant differences in SOC stocks between four different AFS in 354 previous studies. We propose three main explanations to reconcile these different findings. First, in a global meta-analysis, @Ma2020 estimated that it takes only five years for SOC stocks in tropical AFS to reach an equilibrium value. In our study, at least three of the five AFS (namely YA, HG and FG) represent different stages of an AFS transition depending on the age of the trees (Figure\ S\@ref(fig:seq-diagram)). Most of these AFS are more than five years old and may have already reached their equilibrium SOC stocks, which could explain why there was little difference between them. Second, we had a limited number of replicates of each AFS within each site, which certainly reduced the power of the statistical tests. We were only able to identify trends, such as higher SOC in SP in Gariuai, which were similar to previous studies [@Feliciano2018]. Increasing the number of replicates for each AFS could have increased the power of the tests, and potentially resulted in more significant differences between AFS. Third, other pedoclimatic and historical factors can influence SOC stocks, sometimes to a greater extent than the type of AFS, e.g., within-site variability in climate, soil texture (Figures\ S\@ref(fig:clay-corg), S\@ref(fig:altitude-corg)) or previous land use may have significantly influenced SOC stocks [@Wiesmeier2019;@Ma2020]. Our experimental design aimed to limit as much as possible the influence of external co-factors at each site (e.g., variability in farmers' management practices, micro-topography, etc.), but much of the variability cannot be controlled in farmers' plots.

We found a significant difference in SOC between the two sites, with higher SOC stocks at Gariuai than at Osso-Luga. A priori, three factors that differentiate the sites could explain these differences in SOC stocks: climate (through elevation; Figure\ \@ref(fig:map-sites); Figure\ S\@ref(fig:altitude-corg)), soil texture (Table\ S\@ref(fig:site-soil); Figure\ S\@ref(fig:clay-corg)) and history. First, we found that SOC stocks were positively correlated with elevation, both between and within sites (Figure\ S\@ref(fig:altitude-corg)). This result is consistent with those of @Raich2006, who found higher SOC at higher elevations in tropical evergreen forests in various countries (e.g., Congo, Thailand). As changes in elevation are associated with variations in climate (precipitation, temperature), our result is also consistent with previous studies that found higher SOC in areas with higher precipitation [@Schuur2001] and lower temperature [@Raich2006;@MarinSpiotta2013]. Second, soil texture is a key driving process for SOC storage in the tropics [@Don2010;@Wiesmeier2019;@Matus2021]. In particular, many studies have found a strong positive correlation between SOC stocks and the fine mineral fractions of soils [i.e., clay or clay + fine silt content; @Zinn2005]. In our study, we found no significant correlation between SOC stocks and clay + fine silt content when site and depth were included in the model (Figure\ S\@ref(fig:clay-corg)). Furthermore, the Gariuai soils, which had the highest SOC stocks, were also the least clayey. This contradicts the typical (positive) relationship between the fine mineral fraction and SOC stocks. It is therefore unlikely that the difference in SOC stocks between the two sites can be attributed to soil texture. Thirdly, history could be a significant driving factor. Gariuai was continuously inhabited for over 50 years, whereas Osso-Luga was abandoned for almost three decades. The management and care of the AFS in Gariuai, such as pruning, organic inputs related to the presence of livestock, as well as optimization of the different strata in terms of C input, may have led to an increase in soil organic carbon compared to abandoned systems [@Lorenz2014].

## SOC stocks are not explained by variation in AGC stocks

We found no significant relationship between AGC and SOC stocks in either the topsoil layer 0-10 cm depth (H2a refuted) or at 0-30 cm depth (H2b confirmed). Overall, AGC stocks were a poor predictor of SOC stocks. These results may relate to previous findings that SOC stocks saturate much faster than AGC stocks in tropical AFS. For example, in a global meta-analysis, @Ma2020 estimated that it took only five years for SOC stocks in tropical AFS to reach an equilibrium value, but more than three decades for AGC stocks. This desynchronization of SOC and AGC stocks recovery has also been observed in naturally regenerating tropical forests. In a systematic review, @Martin2013 found that SOC in tropical secondary forests changed little with time after disturbance, while AGC increased. @Ojoatre2024 found similar results in a secondary tropical mountain forest. These results suggest that there is little correlation between AGC and SOC stocks once AFS are more than five years old, which is the case in our study for FG, HG (> 5 years old) and partially for YA (2 to 10 years; Table\ S\@ref(tab:afs-typology)). This saturation of SOC stocks even with increasing AGC stocks is counterintuitive, as it might be expected that higher AGC stocks would lead to more litter production and decomposition, some of which would increase SOC stocks. However, @Sayer2019, found that SOC stocks did not increase in a lowland tropical forest in Panama after 15 years of an experimentally doubled aboveground litter input. Two processes could explain these findings. On the one hand, the addition of easily decomposable litter could stimulate microbial decomposition and turnover of old stored SOC [i.e., priming effect; @Sayer2019]. On the other hand, the capacity of the soil to store SOC through organo-mineral associations would be limited by its fine element content (clay + fine silt) (i.e., saturation concept).

In addition to biomass stocks, other vegetation characteristics may account for variations in soil carbon stocks between AFS. For instance, previous studies have shown that tree diversity can enhance SOC sequestration in natural ecosystems [@Spohn2023;@Chen2018] and in AFS [@Manaye2021;@Islam2015]. Moreover, total SOC may be less sensitive to management practices (such as biomass inputs) than specific fractions of SOC [@Haynes2005]. Therefore, it would be interesting to continue with further studies that focus not only on the quantity but also the quality of soil organic matter and its relationship with biodiversity (flora and fauna) in traditional Timorese AFS.

## How to conserve and improve carbon stocks in traditional AFS in Timor-Leste?  

Although agroforestry can make agriculture more resilient to climate change while improving its carbon footprint and biodiversity conservation value [@Cardinael2021], poor adaptation to the local context can explain many failures to adopt new agroforestry techniques [@Coe2014]. Conversely, some traditional agroforestry techniques have evolved in a particular context (biophysical, social and economic) and have adapted to this context [@Gouyon1993;@Aumeeruddy1994;@Peltier1996]. This is the case of the traditional AFS studied here in Timor-Leste. Their heritage and socio-economic values [as shown by @Cogne2024], in addition to their high carbon stock value, confirm the importance of their conservation, both nationally and internationally.

These traditional AFS should be conserved to prevent them from being abandoned as the trees wither or their productivity declines. Clear-cutting old agroforests for full-sun crops can appear to be an attractive short-term strategy, providing a large cash inflow from the sale of wood products, followed by four or five years of agricultural production on fertile land. However, this practice unfortunately results in a significant loss of biodiversity and carbon stored in the biomass, and can lead to an irreversible loss of fertility on the plot through soil degradation and erosion. This phenomenon has been documented in a similar context in Sumatra (Indonesia), where @Gouyon1993 highlighted the fact that old agroforests, which they called “jungle-rubber”, and which are quite similar in structure to “forest gardens” (except for the rubber tree component, which has been replaced by other species in Timor-Leste), were being cleared in favor of more intensive production systems. This trend toward clearing jungle-rubber was subsequently confirmed by @Ekadinata2011, and its impact on carbon stock decline was quantified by @Villamor2014.

Strategies to avoid the clearing of traditional AFS could involve new ways of intensifying production while maintaining high carbon and biodiversity values, and gradually renewing the tree population in the plots. For example, it would be interesting to improve tree regeneration by clearing about one hundred square meters (corresponding to the felling of 1 to 10 trees, depending on their crown area). In these clearings, young trees of species considered interesting for their future production could be associated with first heliophile crops (e.g., cereals), and then shade-tolerant crops (e.g., taro). Additional mechanisms to encourage the renewal of traditional AFS could include the provision of subsidies (e.g., payment of carbon credits) or low-interest loans to farmers wishing to renew their agroforestry plots. Another strategy, which has been successfully implemented in other tropical countries (e.g., for agroforestry coffee), is to improve the incomes of AFS farmers through ‘sustainable agriculture’ certification [@Bertrand2019], although this is primarily applicable to the production of export goods, whereas the AFS studied here are currently oriented toward local consumption and domestic markets.

# Conclusion

Agroforestry systems in the Baucau municipality of Timor-Leste had variable but overall high carbon stocks. These systems have only recently been described in the scientific literature, and more research is needed to improve our knowledge of their diversity and functioning. It is therefore important that all stakeholders, including local authorities, universities, and NGOs, are aware of their existence, diversity, and environmental and social value, in order to propose possible innovations to maintain or improve their functioning.

# Authors' contribution 

All authors contributed to the design of the sampling protocol. MC carried out the fieldwork. CP analyzed the data with the help of MC and VF. CP prepared the manuscript and all authors contributed to the drafting and revision of the manuscript. 

# Acknowledgements

We are grateful to Alain Rival (Cirad) for his facilitation of the field studies and critical revision of the paper, and to the trainees who helped with field data collection: Juvencio Dos Santos (vegetation) and Teofilio Gomes (soil). We would also like to thank the 31 farmers who gave their time to take part in the interviews and field measurements. A first English version of this paper was proofread by Grace Delobel.

This project was co-funded by the European Union and the German Federal Ministry for Economic Cooperation and Development (BMZ) as part of the Partnership for Sustainable Agroforestry (PSAF) - Ai ba Futuru project, implemented by the Deutsche Gesellschaft für Internationale Zusammenarbeit (GIZ). Additional funding for this study was provided by the French Embassy in Jakarta and the French Institute of Timor-Leste.

# Data availability 

All data collected for this study is available in the following Dataverse repository ______.

The R codes used to analyze the data and produce the manuscript (including figures and tables) are available on ______.  

\newpage

# Tables

```{r tab.id = "summary", results = "show", tab.cap = "Mean and associated 95% confidence intervals (in parentheses) of total, aboveground carbon (AGC), belowground carbon (BGC), and soil organic carbon (SOC) stocks in each agroforestry system."}
# calculate median and 95% confidence interval at site level
dataC_afs[, value := paste0(
  signif(mean, 3), " (",
  signif(lwr_mean, 3), "-", 
  signif(upr_mean, 3), ")")] |> 
  subset(variable != "SOC10") |> 
  dcast(afs ~ variable, value.var = "value") |> 
  flextable(col_keys = c("afs", "TOT", "AGC", "BGC", "SOC"), 
            cwidth = c(0.9, 1.2, 1.3, 1.3, 1.2)) |> 
  compose(i = 1, j = "afs", part = "header", value = as_paragraph("Agroforestry system")) |>
  compose(i = 1, j = "TOT", part = "header", value = as_paragraph( "Total C stocks\n(Mg C ha", as_sup("-1"), ")"))|> 
  compose(i = 1, j = "AGC", part = "header", value = as_paragraph( "AGC stocks\n(Mg C ha", as_sup("-1"), ")"))|> 
  compose(i = 1, j = "BGC", part = "header", value = as_paragraph( "BGC stocks\n(Mg C ha", as_sup("-1"), ")"))|> 
  compose(i = 1, j = "SOC", part = "header", value = as_paragraph( "SOC stocks\n(Mg C ha", as_sup("-1"), ")"))
```

</br>

```{r tab.id = "anova", results = "show", tab.cap = "Results of the two 2-way ANOVAs with log-transformed median AGC and SOC as dependent variables, and AFS and site as independent variables. The p-value gives the probability of the means of the categories of each independent variable being the same. Bold p-values are lower than 0.05, and the mean difference between groups is thus considered significantly different than zero."}
anova_table$factor = factor(anova_table$factor)
levels(anova_table$factor) = c("AFS", "site")
flextable(anova_table, col_keys = c("variable", "factor", "pvalue"), 
          cwidth = c(1, 1, 0.8)) |> 
  bold(i = anova_table$pvalue < 0.05, j = 2:3) |> 
  set_header_labels(values = c("Dependent variable", "Independent variable", "p-value")) |> 
  merge_at(i = 1:2, j = 1) |> merge_at(i = 3:4, j = 1) |> 
  fix_border_issues() |> hline(i=2)
```

\newpage

# Figures

```{r fig.id = "map-sites", fig.height = 5, fig.width = 7, fig.cap="Plot location. (a) Map of Timor-Leste showing the location of the two study sites (Gariuai and Osso-Luga) in the Baucau municipality (b) Location of the 15 plots in Gariuai; (c) Location of the 15 plots in Osso-Luga. Panels (b) and (c) share the same spatial scale. In (b) and (c), the plots are represented by dots whose color represents the agroforestry system it belongs to. The background color represents the elevation (m), from the Shuttle Radar Topography Mission (SRTM), specifically the hole-filled CGIAR-SRTM (90 m resolution)."}
## site location: create box around plots
data_box = data_plot[, .(xc = mean(long), yc = mean(lat)), .(site)]
data_box[site == "Gariuai", `:=`(w = 0.1, xc = xc + 0.001)]
data_box[site == "Osso-Luga", w := 0.05]
data_box[, `:=`(x1 = xc - w/2, x2 = xc + w/2, y1 = yc - w/2, y2 = yc + w/2)]

## create Timor map
bbox <- c(124.5, -9.2, 127.5,  -8.3)
timor_map <- map_data("world", region = "Timor-Leste")

g1 = ggplot(timor_map) + 
  annotate(geom = "text", label = "a", x = -Inf, y = Inf, 
           hjust = 0, vjust = 1, fontface = "bold", size = 6) + 
  geom_polygon(aes(x = long, y = lat, group = group), fill="lightgray", colour = "grey") +
  geom_tile(data = data_box, aes(x = xc, y = yc, width = w, height = w), fill = NA, color = 1, linewidth = 0.5) +
  geom_text_repel(data = data_box, aes(x = xc, y = yc, label = site)) + 
  labs(x = "", y = "") +
  theme(legend.position = "top", axis.title = element_blank(), 
        axis.ticks = element_blank(), axis.text = element_blank(), 
        panel.background = element_blank())+
  coord_sf(crs = 'WGS84')

# get elevation information
elev = as.data.frame(terra::rast("data/srtm_62_14.tif"), xy = TRUE)
elevS <- subset(elev, x > data_box[site == "Osso-Luga"]$x1 & 
                  x < data_box[site == "Osso-Luga"]$x2 & 
                  y > data_box[site == "Osso-Luga"]$y1 & 
                  y < data_box[site == "Osso-Luga"]$y2)
elevS$site = "Osso-Luga"
elevG <- subset(elev, x > data_box[site == "Gariuai"]$x1 & 
                  x < data_box[site == "Gariuai"]$x2 & 
                  y > data_box[site == "Gariuai"]$y1 & 
                  y < data_box[site == "Gariuai"]$y2)
elevG$site = "Gariuai"

elevAll = rbind(elevS, elevG)

data_plot[, ID_AF := factor(ID_AF, levels = c("CF", "SP", "YA", "HG", "FG"))]

## Map of sites and plots with elevation
g2 = 
  ggplot(data = elevAll) +
  geom_raster(aes(x = x, y = y, fill=srtm_62_14)) +
  geom_point(data = data_plot, 
             aes(x = long, y = lat, color = ID_AF), size = 2) + 
  geom_point(data = data_plot, 
             aes(x = long, y = lat), shape = 1, size = 2) + 
  scale_fill_gradientn(colours = terrain.colors(10)) +
  scale_color_manual(values = c("#1B9E77", "#D95F02", "#7570B3", "#E7298A", "#E6AB02")) +
  labs(x = NULL, y = NULL, color = NULL, fill="Elevation (m)") +
  annotate(geom = "text", label = "b", x = -Inf, y = Inf, 
           hjust = -0.5, vjust = 1, fontface = "bold", size = 6) + 
  annotate(geom = "text", label = "c", x = Inf, y = -Inf, 
           hjust = 12, vjust = -9.8, fontface = "bold", size = 6) + 
  guides(color = FALSE, fill=guide_colorbar(title.position = "top")) +
  theme(legend.position = c(0.8, 0.85), legend.direction="horizontal", 
        axis.title = element_blank(),
        plot.title = element_text(hjust = 0.5), 
        panel.background = element_blank()) +
  scale_x_continuous(expand = c(0, 0)) + scale_y_continuous(expand = c(0, 0))+
  annotation_scale() +
  coord_sf(crs = 'WGS84')

# get AFS legend
g3 = ggplot(data_plot) +
  geom_point(aes(x = long, y = lat, color = ID_AF)) + 
  labs(color = "AFS") +
  guides(color=guide_legend(ncol=2)) +
  scale_color_manual(values = c("#1B9E77", "#D95F02", "#7570B3", "#E7298A", "#E6AB02")) +
  theme_classic()
l1 = get_legend(g3)

ggarrange(ggarrange(g1, l1), g2, ncol = 1, heights = c(1,2))
```

</br>

```{r fig.id = "barplot", fig.height = 5, fig.width = 6, fig.cap = "Distribution of carbon stocks in each type of AFS (CF: crop and fallow, SP: silvopasture, YA: young agroforest, HG: home garden, FG: forest garden), per site. AGC: Aboveground (biomass) carbon; BGC: belowground (biomass) carbon; SOC: soil organic carbon."}
## reorder factors 
dataC_afs_site[, afs := factor(afs, levels = c("CF", "SP", "YA", "HG", "FG"))]

ggplot(dataC_afs_site[variable %in% c("AGC", "BGC", "SOC")], 
       aes(x = afs, y = mean, fill = variable)) +
  geom_bar(position="stack", stat="identity") + 
  facet_wrap(~site, nrow = 1, strip.position = "bottom") +
  scale_fill_manual(values = c("forestgreen", "darkgoldenrod1", "coral4")) +
  theme_classic() +
  theme(strip.placement = "outside") +
  labs(x = "", y = expression("Carbon stocks (Mg C"*" "*ha^{-1}*")"), fill = "Carbon\npool") +
  scale_y_continuous(expand = c(0, 0))
```

</br>

```{r fig.id = "plot-lmereg", fig.height = 3.5, fig.width = 7, fig.cap = "Scatter plot of aboveground carbon (AGC; x-axis) and soil organic carbon (SOC; y-axis) stocks. SOC stocks were estimated at the topsoil layer (0-10 cm; left panel) and at the total measured depth (0-30 cm; right panel). Each point represents the median C stock value in a sample plot, and the vertical and horizontal error bars are the 95% confidence interval. The colors correspond to the different agroforestry systems (CF: crop and fallow, SP: silvopasture, YA: young agroforest, HG: home garden, FG: forest garden); the different shapes represent the two sites. The dotted lines represent the (non-significant) linear mixed models between log-transformed AGC and SOC stocks. For each linear mixed model, we report the marginal R^2^ (proportion of variance explained by fixed effects only) and the conditional R^2^ (proportion of variance explained by both fixed and random effects). Both x- and y-axes are log-transformed. One plot (AFS: CF, site: Gariuai) with no trees over 30 cm in circumference at breast height (minimum size for measurement) had AGC stocks estimated at 0 Mg C ha^-1^ and was therefore removed from the linear model and the figure."}
dfpred = expand.grid(AGC_mean = exp(seq(min(log(data_reg$AGC_mean), na.rm = TRUE),
                                        max(log(data_reg$AGC_mean), na.rm = TRUE),
                                        length.out = 20)),
                     depth = c("Soil depth: 0-30 cm", "Soil depth: 0-10 cm")) |>
  merge(dfreg[, c("depth", "intercept", "slope")], by = "depth")
setDT(dfpred)
dfpred[, SOC_mean := exp(intercept + slope * log(AGC_mean))]

# stack data for figure
dataC_30 = data_reg[, c("plot", "site", "afs",  
                        "AGC_mean", "AGC_lwr", "AGC_upr",
                        "SOC_mean", "SOC_lwr", "SOC_upr")]
dataC_30$depth = "Soil depth: 0-30 cm"
dataC_10 = data_reg[, c("plot", "site", "afs",   
                        "AGC_mean", "AGC_lwr", "AGC_upr",
                        "SOC10_mean", "SOC10_lwr", "SOC10_upr")]
dataC_10$depth = "Soil depth: 0-10 cm"
colnames(dataC_10) = colnames(dataC_30)
dataC_fig = rbind(dataC_10, dataC_30)

## reorder factors 
dataC_fig[, afs := factor(afs, levels = c("CF", "SP", "YA", "HG", "FG"))]


## figure
ggplot(dataC_fig, aes(color = afs)) +
  geom_point(aes(x = AGC_mean, y = SOC_mean, shape = site), size = 2) +
  geom_text(data = dfreg, aes(label = paste0("R^{2}*' (marg.) = '*", round(R2_marg, 3))),
            x = -Inf, y = Inf, hjust = -0.1, vjust = 1.2, parse = TRUE, color = 1) +
  geom_text(data = dfreg, aes(label = paste0("R^{2}*' (cond.) = '*", round(R2_cond, 3))),
            x = -Inf, y = Inf, hjust = -0.1, vjust = 2.2, parse = TRUE, color = 1) +
  geom_linerange(aes(x = AGC_mean, y = SOC_mean, ymin = SOC_lwr, ymax = SOC_upr)) +
  geom_errorbarh(aes(y = SOC_mean, xmin = AGC_lwr, xmax = AGC_upr)) +
  geom_line(data = dfpred, aes(x = AGC_mean, y = SOC_mean), lty = 2, col = 1) +
  labs(color = "AFS", x = expression("AGC stocks (Mg C"*" "*ha^{-1}*")"), 
       y = expression("SOC stocks (Mg C"*" "*ha^{-1}*")"), shape = "Site") +
  expand_limits(x = 0, y = 0) +
  scale_color_manual(values = c("#1B9E77", "#D95F02", "#7570B3", "#E7298A", "#E6AB02")) +
  scale_x_log10() +
  scale_y_log10() +
  facet_wrap(~depth) +
  theme_classic()
```


# References

<div id="refs"></div>

\newpage

# Supplementary information

## Tables 

```{r site-soil-char}
data_soil$silt <- as.numeric(data_soil$`FINE SILT`) + as.numeric(data_soil$`COARSE SILT`)
data_soil$sand <- as.numeric(data_soil$`FINE SAND`) + as.numeric(data_soil$`COARSE SAND`)

# add site info to data_soil 
data_soil_plot <- merge(data_soil, data_plot[, c("N_PLOT", "site")])

# choose variables to show
vars = c("Corg\n", "N", "Corg_N", "CLAY", "silt", "sand", "pH\n", "Ca", "Mg\n", "K", "Na", "CEC\n")

data_soil_plot = melt(data_soil_plot, 
                      id.vars = c("N_PLOT", "SAMPLE_DEPTH", "site"), 
                      measure.vars = vars)

data_soil_plot[, variable := gsub("\n", "", variable)]

# when value below detection limit: use half of detection value
data_soil_plot[grepl("LD", value), value := as.numeric(strsplit(value, "=")[[1]][2])/2]
data_soil_plot[, value := as.numeric(value)]

# remove NA values
data_soil_plot = subset(data_soil_plot, !is.na(value))

# simulation 1000 values per plot, soil depth and variable with a 12% coefficient
# of variation (CV value from lab)
data_soil_plot_simu = 
  data_soil_plot[, .(
    value = rnorm(1000, value, sd = 0.12*value), n = 1:1000), 
    .(site, N_PLOT, SAMPLE_DEPTH, variable)]

# bootstrap plot values to get mean value at the site level (for each simulation)
data_soil_site_simu = 
  data_soil_plot_simu[, .(
    value = mean(sample(value, length(value), replace = TRUE))),
    .(site, variable, n)]

# convert sand, silt, clay and C content from % into g/kg
data_soil_site_simu[ variable %in% c("Corg", "CLAY", "sand", "silt"), value := value*10]

# calculate mean and 95% confidence interval at site level
data_soil_site  = data_soil_site_simu[, .(
  value = paste0(
    signif(mean(value), 3), " (",
    signif(quantile(value, 0.025), 3), "-", 
    signif(quantile(value, 0.975), 3), ")"
  )), 
  .(site, variable)]


# change table shape to have one column per variable
data_soil_site = dcast(data_soil_site, site ~ variable, value.var = "value")
```

```{r tab.id = "site-soil", tab.lp="supp-tab", results = "show", tab.cap.pre="Table S", tab.cap = "Soil characteristics of the sites (average over 0-30 cm), presented as mean values with 95% confidence intervals (in parentheses). The confidence intervals were calculated by propagating a 12% error on the lab-provided values and obtaining site-level estimates through bootstrapping plot values (1000 simulations). Total organic carbon content (dry combustion method) ; total nitrogen content (dry combustion method) ; pH in water (soil:deionized water ratio of 1:2.5) ; CEC - cation exchangeable capacity - and exchangeable cations (Ca, K, Mg and Na) at soil pH [Cobaltihexamine method; Orsini and Remy, 1976]."}
flextable(
  data_soil_site,
  col_keys = c("site", "CLAY", "silt", "sand", "Corg",
               "N", "Corg_N", "pH", "CEC", "Ca", "K", "Mg", "Na"), 
  cwidth = c(0.5, rep(0.6, 5), rep(0.5, 2), rep(0.6, 5)) 
) |> 
  compose(i = 1, j = "CLAY", part = "header", value = as_paragraph("Clay\n(g kg", as_sup("-1"), ")")) |> 
  compose(i = 1, j = "silt", part = "header", value = as_paragraph("Silt (g kg", as_sup("-1"), ")")) |> 
  compose(i = 1, j = "sand", part = "header", value = as_paragraph("Sand (g kg", as_sup("-1"), ")")) |> 
  compose(i = 1, j = "Corg", part = "header", value = as_paragraph("C content (g kg", as_sup("-1"), ")")) |> 
  compose(i = 1, j = "N", part = "header", value = as_paragraph("N content (g kg", as_sup("-1"), ")")) |>
  compose(i = 1, j = "Corg_N", part = "header", value = as_paragraph("C/N")) |> 
  compose(i = 1, j = "CEC", part = "header", value = as_paragraph( "CEC (cmolc kg", as_sup("-1"), ")")) |> 
  compose(i = 1, j = "Ca", part = "header", value = as_paragraph( "Ca (cmolc kg", as_sup("-1"), ")")) |> 
  compose(i = 1, j = "K", part = "header", value = as_paragraph( "K (cmolc kg", as_sup("-1"), ")")) |> 
  compose(i = 1, j = "Mg", part = "header", value = as_paragraph( "Mg (cmolc kg", as_sup("-1"), ")")) |> 
  compose(i = 1, j = "Na", part = "header", value = as_paragraph( "Na (cmolc kg", as_sup("-1"), ")"))
```

</br>

```{r tab.id = "afs-typology", tab.cap.pre="Table S", tab.cap = "Description of 5 agroforestry systems in Central Timor-Leste.", tab.autonum.start_at=1, tab.lp="supp-tab", results = "show"}
read_excel("tables/afs-typology.xlsx") |> 
  flextable(col_keys = c(
    "Typology adapted from Nair (1993)",
    "Usual location", 
    "Typical plot size (ha)", 
    "Time since installation", 
    "Previous land use"), 
    cwidth = c(1.5, 1.5, 1, 1, 1.5)) 
```

</br>

```{r tetum-scientific-correspondance}
sheets1 = grep("INV", excel_sheets("data/DATA_BIOMASS_TL_LARGE.xlsx"), value = TRUE)
sheets2 = grep("INV", excel_sheets("data/DATA_BIOMASS_TL_SHORT.xlsx"), value = TRUE)

vern1 <- lapply(sheets1, \(x){
  df = read_excel("data/DATA_BIOMASS_TL_LARGE.xlsx", sheet = x)
  df = df[, c("TETUM_NAME", "SCIENTIFIC_NAME")] |>
    unique() |>  subset(!SCIENTIFIC_NAME %in% c("Unknown", "NR", "Unkown"))
})
vern2 <- lapply(sheets2, \(x){
  df = read_excel("data/DATA_BIOMASS_TL_LARGE.xlsx", sheet = x)
  df = df[, c("TETUM_NAME", "SCIENTIFIC_NAME")] |>
    unique() |>  subset(!SCIENTIFIC_NAME %in% c("Unknown", "NR", "Unkown"))
})

vern = rbind(rbindlist(vern1), rbindlist(vern2)) |>  unique()
vern <- subset(vern, !is.na(TETUM_NAME) & !is.na(SCIENTIFIC_NAME))

## correct typos in vernacular names
vern[, TETUM_NAME := tolower(gsub(" oan| kain| restu| hun restu", "", TETUM_NAME))]

vern[,grep("tali", TETUM_NAME, value=T)]

vern[grep("kami", TETUM_NAME), TETUM_NAME := "ai-kamii"]
vern[, TETUM_NAME := gsub("ai-haek", "ai-hanek", TETUM_NAME)]
vern[, TETUM_NAME := gsub("ai-bobur", "ai-bubur", TETUM_NAME)]
vern[, TETUM_NAME := gsub("duut", "du'ut", TETUM_NAME)]
vern[, TETUM_NAME := gsub("aifarina", "ai-farina", TETUM_NAME)]
vern[, TETUM_NAME := gsub("aitarak", "ai-tarak", TETUM_NAME)]
vern[, TETUM_NAME := gsub("ainanas", "ai-nanas", TETUM_NAME)]
vern[, TETUM_NAME := gsub("fore tali", "fore-tali", TETUM_NAME)]
vern[, TETUM_NAME := gsub("kromolaina", "kromolaena", TETUM_NAME)]

## correct scientific names
vern[, c("genus", "species") := tstrsplit(SCIENTIFIC_NAME, " ")[1:2]]
vern[species %in% c("sp", "sp."), species := NA]
vern[species == "purpuroides", species := NA]
corr = correctTaxo(genus = vern$genus, species = vern$species)
vern = cbind(vern, corr)

vern[, latin := paste(genusCorrected, speciesCorrected)]
vern[, latin := gsub(" NA", " sp.", latin)]
vern[,tetum := gsub("  ", " ", tolower(TETUM_NAME))]
vern <- vern[, c("tetum", "latin", "genusCorrected", "speciesCorrected")]
vern = unique(vern)

# check that all names are unique
# if one tetum name has two levels of id (same genus), keep better identification
dupl_tetum <- vern[duplicated(tetum), unique(tetum)]
vern = vern[!(tetum %in% dupl_tetum & is.na(speciesCorrected))]
setorder(vern, latin)

vern = vern[, .(tetum = paste(tetum, collapse = ", ")), .(latin)]
``` 

```{r tab.id = "tetum-names", tab.lp="supp-tab", results = "show", tab.cap.pre="Table S", tab.cap = "Correspondence between Tetum names and scientific names used in this study."}
flextable(vern) |> 
  set_header_labels(values =  c("Scientific name", "Tetum name")) |> 
  autofit()
```

## Figures 

```{r fig.id="design", fig.cap = "Plot sampling design. (a) Typical plot < 1 ha, in all AFS except SPs. (b) Typical 1-ha plot in SPs. Red areas are the five 10x10 m subplots, and blue dots are the three soil sampling locations.", fig.autonum.start_at=1, fig.lp="supp-fig", results = "show", fig.cap.pre="Figure S", fig.width = 5, fig.height = 3}
include_graphics("figures/plot-design.jpg") 
```

</br>

```{r fig.id="seq-diagram", fig.cap = "Typical sequence of AFS in the sites included in this study. Transitions between two systems are represented by arrows: dashed arrows represent transitions that usually include tree removal, whereas solid arrows represent transitions where trees are planted and/or the AFS is left to regenerate naturally. These transitions may vary according to the farmer's strategy and available resources (Cogné and Lescuyer, 2024).", fig.lp="supp-fig", results = "show", fig.cap.pre="Figure S", fig.width = 8, fig.height = 2.2}
# save_png <- function(plot, path){
#   DiagrammeRsvg::export_svg(plot) %>%
#     charToRaw() %>%
#     rsvg::rsvg() %>%
#     png::writePNG(path)
# }
# 
# DiagrammeR::grViz("
#       digraph {
#       graph [layout = dot, rankdir = LR]
# 
#       node [shape = ellipse]
#       CF[color = '#1B9E77'];
#       SP[color = '#D95F02'];
#       YA[color = '#7570B3'];
#       HG[color = '#E7298A'];
#       FG[color = '#E6AB02'];
# 
#       NE[label = 'Forest or\nsavanna', shape = rectangle, fillcolor ='black'];
# 
#       # Connect nodes with edges and labels
#       CF -> YA -> HG -> FG;
#       YA -> FG;
#       edge[style = 'dashed']
#       SP -> CF;
#       FG -> CF
#       FG -> YA
#       NE -> SP
#       NE -> CF
#        }
# 
#       ") %>%
#   save_png("figures/seq_diagram.png")
include_graphics("figures/seq_diagram.png") 
```


</br>

```{r fig.id="altitude-corg", fig.height = 4, fig.width = 6, fig.lp="supp-fig", fig.cap = "Effect of plot elevation (x-axis; in m) on SOC stocks (y-axis; in\ Mg\ C\ ha^-1^). Points are colored by site; the point corresponds to the mean prediction at that site, while the error bars correspond to the 95% confidence interval. We performed a linear mixed effects regression with log-transformed SOC stocks as the dependent variable, log-transformed elevation as the independent variable, and site as random effect. Results are presented as regression lines and the p-value of the relationship between SOC stocks and elevation.", fig.cap.pre="Figure S"}
dataCelev = merge(dataC_plot[variable=="SOC", c("plot", "site", "mean", "upr", "lwr")], 
                  data_plot[, c("N_PLOT", "long", "lat")], by.x = "plot", by.y = "N_PLOT")

# extract elevation
dataCelev[, elev := terra::extract(
  terra::rast("data/srtm_62_14.tif"), 
  cbind(long, lat)
)]

regElev = lmer(log(mean) ~ log(elev) + (1|site), data = dataCelev) |> 
  summary()
pvalueE = signif(regElev$coefficients[2, 5], 2)
slp = regElev$coefficients[2, 1]

dfElev = dataCelev[, .(
  int = mean(log(mean)) - slp * mean(log(elev)), 
  elev = min(elev), elevMax = max(elev),
  slp = slp), .(site)] 
dfElev[, mean := exp(slp*log(elev) + int)]
dfElev[, predMax := exp(slp*log(elevMax) + int)]


ggplot(dataCelev, aes(x = elev, y = mean, col = site)) +
  geom_pointrange(aes(ymin=lwr, ymax = upr)) + 
  geom_segment(data = dfElev, aes(xend = elevMax, yend = predMax)) +
  theme_classic() +
  annotate(geom = "text", label = paste("p-value =", pvalueE), x = 500, y = 32) +
  labs(x = "Elevation (m)", y = expression("SOC stocks (Mg C"*" "*ha^{-1}*")"), col = "Site") +
  scale_x_log10() + scale_y_log10()
```


</br>

```{r fig.id = "clay-corg", fig.height = 4, fig.width = 6, fig.lp="supp-fig", fig.cap="Distribution of SOC content (y-axis; in %) values as a function of fine silt and clay content (x-axis; in %), soil depth (point color; in cm), and site (point shape). We performed a linear mixed effects regression with log-transformed SOC content as the dependent variable, log-transformed fine soil texture as the independent variable, and soil depth and site as random effects. Results are presented as regression lines and the p-value of the relationship between SOC content and fine soil texture.", fig.cap.pre="Figure S"}

data_soil[, site := substr(ID_VILLAGE, 1, 1)]
data_soil[site == "S", site := "Osso-Luga"]
data_soil[site == "G", site := "Gariuai"]

regText = lmer(
  log(Corg) ~ log(as.numeric(CLAY) + as.numeric(`FINE SILT`)) + 
    (1|site)+ 
    (1|SAMPLE_DEPTH), 
  data = data_soil[SAMPLE_DEPTH != "10-20"]) |> 
  summary()
pvalueT = signif(regText$coefficients[2, 5], 3)
slp = regText$coefficients[2, 1]

dfText = data_soil[SAMPLE_DEPTH != "10-20" & !is.na(CLAY), .(
  int = mean(log(Corg)) - slp * mean(log(as.numeric(CLAY) + as.numeric(`FINE SILT`))), 
  xmin = min(as.numeric(CLAY) + as.numeric(`FINE SILT`)), 
  xmax = max(as.numeric(CLAY) + as.numeric(`FINE SILT`)),
  slp = slp), .(site, SAMPLE_DEPTH)] 
dfText[, predMin := exp(slp*log(xmin) + int)]
dfText[, predMax := exp(slp*log(xmax) + int)]

ggplot(data_soil[SAMPLE_DEPTH != "10-20"], aes(x = as.numeric(CLAY) + as.numeric(`FINE SILT`), y = Corg, shape = SAMPLE_DEPTH, col = site)) +
  geom_point() +
  geom_segment(data = dfText, aes(x = xmin, y = predMin, xend = xmax, yend = predMax, lty = SAMPLE_DEPTH)) +
  scale_x_log10() + scale_y_log10() +
  scale_linetype_manual(values=c("twodash", "dotted")) +
  labs(shape = "Soil depth (cm)", lty = "Soil depth (cm)", 
       x = "Clay and fine silt content (%)", 
       y = "SOC content (%)", 
       col = "Site") +
  annotate(geom = "text", label = paste("p-value =", pvalueT), x = 45, y = 1) +
  theme_classic()
```

